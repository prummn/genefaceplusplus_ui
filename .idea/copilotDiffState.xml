<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app.py" />
              <option name="originalContent" value="from flask import Flask, render_template, request, jsonify, send_file&#10;from pydub import AudioSegment&#10;import os&#10;import uuid&#10;import re&#10;import time&#10;from werkzeug.utils import secure_filename&#10;from datetime import datetime&#10;&#10;# 引入后端模块&#10;from backend.video_generator import generate_video&#10;from backend.model_trainer import (&#10;    train_model, &#10;    stop_train_remote,&#10;    geneface_health,&#10;    geneface_api_call,&#10;    geneface_list_videos&#10;)&#10;from backend.chat_engine import chat_response, clear_chat_history&#10;&#10;BASE_DIR = os.path.dirname(os.path.abspath(__file__))&#10;&#10;app = Flask(__name__)&#10;&#10;# --- 页面路由 ---&#10;&#10;@app.route('/')&#10;def index():&#10;    return render_template('index.html')&#10;&#10;@app.route('/video_generation', methods=['GET', 'POST'])&#10;def video_generation():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_name&quot;: request.form.get('model_name'),&#10;            &quot;model_param&quot;: request.form.get('model_param'),&#10;            &quot;ref_audio&quot;: request.form.get('ref_audio'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;target_text&quot;: request.form.get('target_text'),&#10;            &quot;voice_clone&quot;: request.form.get('voice_clone'),&#10;            # GeneFace++ 参数&#10;            &quot;gf_head_ckpt&quot;: request.form.get('gf_head_ckpt'),&#10;            &quot;gf_torso_ckpt&quot;: request.form.get('gf_torso_ckpt'),&#10;            &quot;gf_audio_path&quot;: request.form.get('gf_audio_path'),&#10;        }&#10;&#10;        video_path = generate_video(data)&#10;        return jsonify({'status': 'success', 'video_path': video_path})&#10;&#10;    default_video = 'videos/sample.mp4'&#10;    latest_video_path = os.path.join('static', 'videos', 'geneface_latest.mp4')&#10;    if os.path.exists(os.path.join(BASE_DIR, latest_video_path)):&#10;        default_video = 'videos/geneface_latest.mp4'&#10;&#10;    return render_template('video_generation.html', default_video=default_video)&#10;&#10;@app.route('/model_training', methods=['GET', 'POST'])&#10;def model_training():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_choice&quot;: request.form.get('model_choice'),&#10;            &quot;ref_video&quot;: request.form.get('ref_video'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;epoch&quot;: request.form.get('epoch'),&#10;            &quot;custom_params&quot;: request.form.get('custom_params'),&#10;            # GeneFace++ 专用参数&#10;            &quot;video_id&quot;: request.form.get('video_id'),&#10;            &quot;train_stage&quot;: request.form.get('train_stage'),&#10;            &quot;max_updates_head&quot;: request.form.get('max_updates_head'),&#10;            &quot;max_updates_torso&quot;: request.form.get('max_updates_torso'),&#10;            &quot;head_ckpt&quot;: request.form.get('head_ckpt'),&#10;        }&#10;&#10;        result = train_model(data)&#10;&#10;        if isinstance(result, dict):&#10;            return jsonify(result)&#10;        else:&#10;            return jsonify({'status': 'success', 'video_path': result})&#10;&#10;    return render_template('model_training.html')&#10;&#10;@app.route('/chat_system', methods=['GET', 'POST'])&#10;def chat_system():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_name&quot;: request.form.get('model_name'),&#10;            &quot;model_param&quot;: request.form.get('model_param'),&#10;            &quot;voice_clone&quot;: request.form.get('voice_clone'),&#10;            &quot;api_choice&quot;: request.form.get('api_choice'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;voice_clone_model&quot;: request.form.get('voice_clone_model'),&#10;            &quot;gf_torso_ckpt&quot;: request.form.get('gf_torso_ckpt'),&#10;            &quot;gf_head_ckpt&quot;: request.form.get('gf_head_ckpt'),&#10;        }&#10;&#10;        try:&#10;            result_path = chat_response(data)&#10;            # 统一路径格式为 Web 路径&#10;            if result_path:&#10;                result_path = &quot;/&quot; + result_path.replace(&quot;\\&quot;, &quot;/&quot;) if not result_path.startswith(&quot;/&quot;) else result_path&#10;            return jsonify({'status': 'success', 'video_path': result_path})&#10;        except Exception as e:&#10;            print(f&quot;Chat System Error: {e}&quot;)&#10;            return jsonify({'status': 'error', 'message': str(e)}), 500&#10;&#10;    return render_template('chat_system.html')&#10;&#10;# --- 功能接口 ---&#10;&#10;@app.route('/geneface/stop/&lt;task_id&gt;', methods=['POST'])&#10;def geneface_stop(task_id):&#10;    &quot;&quot;&quot;停止指定 ID 的训练任务&quot;&quot;&quot;&#10;    cmd = request.form.get('cmd', type=int)&#10;    # 注意：这里假设 stop_train_remote 接受 task_id 或 cmd，根据原逻辑调整&#10;    # 如果原逻辑是用 cmd 参数控制，这里保留原样&#10;    result = stop_train_remote(cmd)&#10;    &#10;    if isinstance(result, dict):&#10;        return jsonify(result)&#10;    else:&#10;        return jsonify({'status': 'success', 'message': str(result)})&#10;&#10;@app.route('/save_audio', methods=['POST'])&#10;def save_audio():&#10;    if 'audio' not in request.files:&#10;        return jsonify({'status': 'error', 'message': '没有音频文件'})&#10;&#10;    audio_file = request.files['audio']&#10;    if audio_file.filename == '':&#10;        return jsonify({'status': 'error', 'message': '没有选择文件'})&#10;&#10;    save_dir = os.path.join(BASE_DIR, 'io', &quot;history&quot;)&#10;    os.makedirs(save_dir, exist_ok=True)&#10;&#10;    raw_file_path = os.path.join(save_dir, 'aud_raw_from_browser')&#10;    audio_file.save(raw_file_path)&#10;&#10;    final_wav_path = os.path.join(save_dir, 'latest_user_aud.wav')&#10;&#10;    try:&#10;        print(f&quot;[app.py] 收到原始音频，正在从 {raw_file_path} 加载...&quot;)&#10;        audio = AudioSegment.from_file(raw_file_path)&#10;        &#10;        print(f&quot;[app.py] 正在重新导出为标准 WAV: {final_wav_path}&quot;)&#10;        # 强制转为单声道和16k采样率以兼容 ASR/RVC&#10;        audio = audio.set_channels(1).set_frame_rate(16000)&#10;        audio.export(final_wav_path, format=&quot;wav&quot;)&#10;        print(f&quot;[app.py] 音频保存并修复成功。&quot;)&#10;&#10;    except Exception as e:&#10;        print(f&quot;!!!!!!!!!!!!!! [app.py] 严重错误: 修复音频文件失败 !!!!!!!!!!!!!!&quot;)&#10;        print(f&quot;Error: {e}&quot;)&#10;        return jsonify({'status': 'error', 'message': f'后台处理音频文件失败 (请检查ffmpeg): {e}'}), 500&#10;    finally:&#10;        try:&#10;            if os.path.exists(raw_file_path):&#10;                os.remove(raw_file_path)&#10;        except Exception:&#10;            pass&#10;&#10;    # 返回给前端的路径可以不包含盘符，用于展示或调试&#10;    return jsonify({'status': 'success', 'message': '音频保存并修复成功', 'file_path': 'io/history/latest_user_aud.wav'})&#10;&#10;@app.route('/clear_history', methods=['POST'])&#10;def clear_history():&#10;    &quot;&quot;&quot;清除对话历史&quot;&quot;&quot;&#10;    success, msg = clear_chat_history()&#10;    if success:&#10;        return jsonify({'status': 'success', 'message': msg})&#10;    else:&#10;        return jsonify({'status': 'error', 'message': msg})&#10;&#10;@app.route('/list_ref_audios', methods=['GET'])&#10;def list_ref_audios():&#10;    &quot;&quot;&quot;列出 io/input/audio 下的参考音频&quot;&quot;&quot;&#10;    audio_dir = os.path.join(BASE_DIR, &quot;io&quot;, &quot;input&quot;, &quot;audio&quot;)&#10;    audios = []&#10;    if os.path.exists(audio_dir):&#10;        for f in os.listdir(audio_dir):&#10;            if f.lower().endswith(('.wav', '.mp3', '.m4a', '.flac')):&#10;                audios.append(f)&#10;    return jsonify(audios)&#10;&#10;@app.route('/upload_ref_audio', methods=['POST'])&#10;def upload_ref_audio():&#10;    &quot;&quot;&quot;上传参考音频 (增强版: 支持自动转码和UUID命名)&quot;&quot;&quot;&#10;    if 'audio' not in request.files:&#10;        return jsonify({'status': 'error', 'message': '请求中没有音频文件'})&#10;    &#10;    file = request.files['audio']&#10;    if file.filename == '':&#10;        return jsonify({'status': 'error', 'message': '未选择文件'})&#10;        &#10;    try:&#10;        # 1. 定义路径&#10;        temp_dir = os.path.join(BASE_DIR, 'io', 'temp')&#10;        final_dir = os.path.join(BASE_DIR, 'io', 'input', 'audio')&#10;        os.makedirs(temp_dir, exist_ok=True)&#10;        os.makedirs(final_dir, exist_ok=True)&#10;        &#10;        # 2. 保存原始文件到 temp (使用UUID防止中文名问题)&#10;        original_ext = os.path.splitext(file.filename)[1].lower()&#10;        if not original_ext: original_ext = &quot;.wav&quot;&#10;            &#10;        temp_filename = f&quot;upload_temp_{uuid.uuid4().hex}{original_ext}&quot;&#10;        temp_path = os.path.join(temp_dir, temp_filename)&#10;        file.save(temp_path)&#10;        &#10;        # 3. 准备最终文件名&#10;        original_stem = os.path.splitext(file.filename)[0]&#10;        # 尝试保留原始文件名主体，如果 secure_filename 变为空(如纯中文)，则生成随机名&#10;        safe_stem = secure_filename(original_stem)&#10;        if not safe_stem: &#10;            safe_stem = f&quot;ref_{uuid.uuid4().hex[:8]}&quot;&#10;            &#10;        final_filename = f&quot;{safe_stem}.wav&quot;&#10;        final_path = os.path.join(final_dir, final_filename)&#10;        &#10;        # 避免文件名冲突&#10;        counter = 1&#10;        while os.path.exists(final_path):&#10;            final_filename = f&quot;{safe_stem}_{counter}.wav&quot;&#10;            final_path = os.path.join(final_dir, final_filename)&#10;            counter += 1&#10;        &#10;        print(f&quot;[Upload] 正在转换: {temp_path} -&gt; {final_path}&quot;)&#10;        &#10;        # 4. 转换格式&#10;        try:&#10;            audio = AudioSegment.from_file(temp_path)&#10;            audio = audio.set_channels(1) # 转单声道&#10;            audio.export(final_path, format=&quot;wav&quot;)&#10;        except FileNotFoundError:&#10;            raise Exception(&quot;服务器未安装 ffmpeg，无法转换音频格式。&quot;)&#10;        except Exception as trans_e:&#10;            raise Exception(f&quot;音频转换失败: {trans_e}&quot;)&#10;        &#10;        # 5. 清理&#10;        if os.path.exists(temp_path):&#10;            os.remove(temp_path)&#10;            &#10;        print(f&quot;[Upload] 完成: {final_path}&quot;)&#10;        return jsonify({'status': 'success', 'filename': final_filename})&#10;        &#10;    except Exception as e:&#10;        print(f&quot;[Upload] Error: {e}&quot;)&#10;        # 尝试清理&#10;        if 'temp_path' in locals() and os.path.exists(temp_path):&#10;            try: os.remove(temp_path)&#10;            except: pass&#10;        return jsonify({'status': 'error', 'message': str(e)})&#10;&#10;# --- GeneFace++ 专用接口 ---&#10;&#10;@app.route('/geneface/health', methods=['GET'])&#10;def geneface_health_check():&#10;    &quot;&quot;&quot;检查 GeneFace++ 服务&quot;&quot;&quot;&#10;    is_ok = geneface_health()&#10;    return jsonify({&#10;        &quot;status&quot;: &quot;ok&quot; if is_ok else &quot;unavailable&quot;,&#10;        &quot;message&quot;: &quot;服务正常&quot; if is_ok else &quot;请启动 Docker: docker start geneface&quot;&#10;    })&#10;&#10;@app.route('/geneface/videos', methods=['GET'])&#10;def geneface_videos():&#10;    &quot;&quot;&quot;列出可用视频&quot;&quot;&quot;&#10;    return jsonify(geneface_api_call(&quot;/videos&quot;))&#10;&#10;@app.route('/geneface/upload', methods=['POST'])&#10;def geneface_upload():&#10;    &quot;&quot;&quot;上传视频到 GeneFace++&quot;&quot;&quot;&#10;    if 'video' not in request.files:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;没有视频文件&quot;}), 400&#10;&#10;    video_file = request.files['video']&#10;    video_id = request.form.get('video_id')&#10;&#10;    if not video_id:&#10;        video_id = os.path.splitext(secure_filename(video_file.filename))[0]&#10;&#10;    video_id = re.sub(r'[^a-zA-Z0-9_]', '_', video_id)&#10;&#10;    geneface_video_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;videos&quot;)&#10;    os.makedirs(geneface_video_dir, exist_ok=True)&#10;&#10;    save_path = os.path.join(geneface_video_dir, f&quot;{video_id}.mp4&quot;)&#10;    video_file.save(save_path)&#10;&#10;    return jsonify({&#10;        &quot;status&quot;: &quot;success&quot;,&#10;        &quot;video_id&quot;: video_id,&#10;        &quot;message&quot;: &quot;视频上传成功&quot;&#10;    })&#10;&#10;@app.route('/geneface/upload_audio', methods=['POST'])&#10;def geneface_upload_audio():&#10;    &quot;&quot;&quot;上传音频到 GeneFace++ 数据目录&quot;&quot;&quot;&#10;    if 'audio' not in request.files:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;没有音频文件&quot;}), 400&#10;&#10;    audio_file = request.files['audio']&#10;    audio_name = request.form.get('audio_name')&#10;&#10;    if not audio_name:&#10;        audio_name = os.path.splitext(secure_filename(audio_file.filename))[0]&#10;&#10;    # Ensure safe filename&#10;    audio_name = re.sub(r'[^a-zA-Z0-9_]', '_', audio_name)&#10;&#10;    # Target directory: GeneFace/data/raw/val_wavs&#10;    target_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;val_wavs&quot;)&#10;    os.makedirs(target_dir, exist_ok=True)&#10;&#10;    save_path = os.path.join(target_dir, f&quot;{audio_name}.wav&quot;)&#10;&#10;    try:&#10;        # Save to temp first&#10;        temp_path = os.path.join(target_dir, f&quot;temp_{audio_name}_{uuid.uuid4().hex}.tmp&quot;)&#10;        audio_file.save(temp_path)&#10;&#10;        # Convert to wav using pydub&#10;        audio = AudioSegment.from_file(temp_path)&#10;        audio.export(save_path, format=&quot;wav&quot;)&#10;&#10;        if os.path.exists(temp_path):&#10;            os.remove(temp_path)&#10;&#10;        return jsonify({&#10;            &quot;status&quot;: &quot;success&quot;,&#10;            &quot;message&quot;: &quot;音频上传成功&quot;,&#10;            &quot;path&quot;: save_path,&#10;            &quot;name&quot;: audio_name&#10;        })&#10;    except Exception as e:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: str(e)}), 500&#10;&#10;@app.route('/geneface/task/&lt;task_id&gt;', methods=['GET'])&#10;def geneface_task(task_id):&#10;    return jsonify(geneface_api_call(f&quot;/task/{task_id}&quot;))&#10;&#10;@app.route('/geneface/tasks', methods=['GET'])&#10;def geneface_tasks():&#10;    return jsonify(geneface_api_call(&quot;/tasks&quot;))&#10;&#10;@app.route('/geneface/models', methods=['GET'])&#10;def geneface_models():&#10;    &quot;&quot;&quot;列出已训练模型&quot;&quot;&quot;&#10;    models = []&#10;    ckpt_base = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;checkpoints&quot;, &quot;motion2video_nerf&quot;)&#10;&#10;    if os.path.exists(ckpt_base):&#10;        video_models = {}&#10;        for name in os.listdir(ckpt_base):&#10;            full_path = os.path.join(ckpt_base, name)&#10;            if os.path.isdir(full_path):&#10;                if name.endswith('_head'):&#10;                    video_id = name[:-5]&#10;                    if video_id not in video_models:&#10;                        video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                    for root, dirs, files in os.walk(full_path):&#10;                        for f in files:&#10;                            if f.endswith(('.ckpt', '.pt')):&#10;                                rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                                rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                                video_models[video_id][&quot;head_checkpoints&quot;].append(rel_path)&#10;                elif name.endswith('_torso'):&#10;                    video_id = name[:-6]&#10;                    if video_id not in video_models:&#10;                        video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                    for root, dirs, files in os.walk(full_path):&#10;                        for f in files:&#10;                            if f.endswith(('.ckpt', '.pt')):&#10;                                rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                                rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                                video_models[video_id][&quot;torso_checkpoints&quot;].append(rel_path)&#10;&#10;        for vid, data in video_models.items():&#10;            data[&quot;head_checkpoints&quot;].sort(key=lambda x: os.path.getmtime(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) if os.path.exists(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) else 0, reverse=True)&#10;            data[&quot;torso_checkpoints&quot;].sort(key=lambda x: os.path.getmtime(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) if os.path.exists(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) else 0, reverse=True)&#10;&#10;        models = list(video_models.values())&#10;&#10;    return jsonify(models)&#10;&#10;@app.route('/geneface/models_local', methods=['GET'])&#10;def geneface_models_local():&#10;    &quot;&quot;&quot;扫描本地 GeneFace checkpoints 目录&quot;&quot;&quot;&#10;    checkpoints_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;checkpoints&quot;, &quot;motion2video_nerf&quot;)&#10;    models = []&#10;&#10;    if os.path.exists(checkpoints_dir):&#10;        # 获取所有子文件夹&#10;        subdirs = [d for d in os.listdir(checkpoints_dir) if os.path.isdir(os.path.join(checkpoints_dir, d))]&#10;&#10;        for subdir in subdirs:&#10;            # 简单的过滤，通常我们关注 _torso 结尾的作为身体模型，但用户可能想要所有&#10;            # 这里我们列出所有文件夹，并扫描其中的 .ckpt/.pt 文件&#10;            dir_path = os.path.join(checkpoints_dir, subdir)&#10;            files = [f for f in os.listdir(dir_path) if f.endswith('.ckpt') or f.endswith('.pt')]&#10;&#10;            # 按修改时间排序，最新的在前&#10;            files.sort(key=lambda x: os.path.getmtime(os.path.join(dir_path, x)), reverse=True)&#10;&#10;            if files:&#10;                # 尝试推断对应的 head 文件夹&#10;                head_dir_name = subdir.replace(&quot;_torso&quot;, &quot;_head&quot;)&#10;                head_checkpoints = []&#10;                head_dir_path = os.path.join(checkpoints_dir, head_dir_name)&#10;                if os.path.exists(head_dir_path) and os.path.isdir(head_dir_path):&#10;                     head_files = [f for f in os.listdir(head_dir_path) if f.endswith('.ckpt') or f.endswith('.pt')]&#10;                     head_files.sort(key=lambda x: os.path.getmtime(os.path.join(head_dir_path, x)), reverse=True)&#10;                     head_checkpoints = [os.path.join(&quot;checkpoints&quot;, &quot;motion2video_nerf&quot;, head_dir_name, f).replace(&quot;\\&quot;, &quot;/&quot;) for f in head_files]&#10;&#10;                models.append({&#10;                    &quot;video_id&quot;: subdir, # 这里用文件夹名作为 ID&#10;                    &quot;torso_checkpoints&quot;: [os.path.join(&quot;checkpoints&quot;, &quot;motion2video_nerf&quot;, subdir, f).replace(&quot;\\&quot;, &quot;/&quot;) for f in files],&#10;                    &quot;head_checkpoints&quot;: head_checkpoints&#10;                })&#10;&#10;    return jsonify(models)&#10;&#10;@app.route('/geneface/video/&lt;video_id&gt;')&#10;def geneface_video_file(video_id):&#10;    video_id = re.sub(r'[^a-zA-Z0-9_-]', '', video_id)&#10;    video_path = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;videos&quot;, f&quot;{video_id}.mp4&quot;)&#10;    if os.path.exists(video_path):&#10;        return send_file(video_path, mimetype='video/mp4')&#10;    else:&#10;        return jsonify({&quot;error&quot;: &quot;视频不存在&quot;}), 404&#10;&#10;@app.route('/geneface/audios', methods=['GET'])&#10;def geneface_audios():&#10;    return jsonify(geneface_api_call(&quot;/audios&quot;))&#10;&#10;@app.route('/geneface/upload_audio', methods=['POST'])&#10;def geneface_upload_audio():&#10;    if 'audio' not in request.files:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;没有音频文件&quot;}), 400&#10;&#10;    audio_file = request.files['audio']&#10;    audio_name = request.form.get('audio_name')&#10;&#10;    if not audio_name:&#10;        audio_name = os.path.splitext(secure_filename(audio_file.filename))[0]&#10;&#10;    audio_name = re.sub(r'[^a-zA-Z0-9_-]', '_', audio_name)&#10;    audio_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;val_wavs&quot;)&#10;    os.makedirs(audio_dir, exist_ok=True)&#10;&#10;    ext = os.path.splitext(audio_file.filename)[1].lower()&#10;    if ext not in ['.wav', '.mp3', '.m4a']:&#10;        ext = '.wav'&#10;&#10;    save_path = os.path.join(audio_dir, f&quot;{audio_name}{ext}&quot;)&#10;    audio_file.save(save_path)&#10;    rel_path = f&quot;data/raw/val_wavs/{audio_name}{ext}&quot;&#10;&#10;    return jsonify({&#10;        &quot;status&quot;: &quot;success&quot;,&#10;        &quot;audio_name&quot;: f&quot;{audio_name}{ext}&quot;,&#10;        &quot;audio_path&quot;: rel_path&#10;    })&#10;&#10;@app.route('/geneface/infer', methods=['POST'])&#10;def geneface_infer():&#10;    data = request.json&#10;    return jsonify(geneface_api_call(&quot;/infer&quot;, &quot;POST&quot;, data))&#10;&#10;@app.route('/geneface/output/&lt;path:filename&gt;')&#10;def geneface_output_file(filename):&#10;    filename = secure_filename(filename)&#10;    video_path = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;infer_out&quot;, filename)&#10;    if os.path.exists(video_path):&#10;        return send_file(video_path, mimetype='video/mp4')&#10;    else:&#10;        return jsonify({&quot;error&quot;: &quot;视频不存在&quot;}), 404&#10;&#10;if __name__ == '__main__':&#10;    app.run(host='0.0.0.0', debug=True, port=5000, use_reloader=False)" />
              <option name="updatedContent" value="from flask import Flask, render_template, request, jsonify, send_file&#10;from pydub import AudioSegment&#10;import os&#10;import uuid&#10;import re&#10;import time&#10;from werkzeug.utils import secure_filename&#10;from datetime import datetime&#10;&#10;# 引入后端模块&#10;from backend.video_generator import generate_video&#10;from backend.model_trainer import (&#10;    train_model, &#10;    stop_train_remote,&#10;    geneface_health,&#10;    geneface_api_call,&#10;    geneface_list_videos&#10;)&#10;from backend.chat_engine import chat_response, clear_chat_history&#10;&#10;BASE_DIR = os.path.dirname(os.path.abspath(__file__))&#10;&#10;app = Flask(__name__)&#10;&#10;# --- 页面路由 ---&#10;&#10;@app.route('/')&#10;def index():&#10;    return render_template('index.html')&#10;&#10;@app.route('/video_generation', methods=['GET', 'POST'])&#10;def video_generation():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_name&quot;: request.form.get('model_name'),&#10;            &quot;model_param&quot;: request.form.get('model_param'),&#10;            &quot;ref_audio&quot;: request.form.get('ref_audio'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;target_text&quot;: request.form.get('target_text'),&#10;            &quot;voice_clone&quot;: request.form.get('voice_clone'),&#10;            # GeneFace++ 参数&#10;            &quot;gf_head_ckpt&quot;: request.form.get('gf_head_ckpt'),&#10;            &quot;gf_torso_ckpt&quot;: request.form.get('gf_torso_ckpt'),&#10;            &quot;gf_audio_path&quot;: request.form.get('gf_audio_path'),&#10;        }&#10;&#10;        video_path = generate_video(data)&#10;        return jsonify({'status': 'success', 'video_path': video_path})&#10;&#10;    default_video = 'videos/sample.mp4'&#10;    latest_video_path = os.path.join('static', 'videos', 'geneface_latest.mp4')&#10;    if os.path.exists(os.path.join(BASE_DIR, latest_video_path)):&#10;        default_video = 'videos/geneface_latest.mp4'&#10;&#10;    return render_template('video_generation.html', default_video=default_video)&#10;&#10;@app.route('/model_training', methods=['GET', 'POST'])&#10;def model_training():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_choice&quot;: request.form.get('model_choice'),&#10;            &quot;ref_video&quot;: request.form.get('ref_video'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;epoch&quot;: request.form.get('epoch'),&#10;            &quot;custom_params&quot;: request.form.get('custom_params'),&#10;            # GeneFace++ 专用参数&#10;            &quot;video_id&quot;: request.form.get('video_id'),&#10;            &quot;train_stage&quot;: request.form.get('train_stage'),&#10;            &quot;max_updates_head&quot;: request.form.get('max_updates_head'),&#10;            &quot;max_updates_torso&quot;: request.form.get('max_updates_torso'),&#10;            &quot;head_ckpt&quot;: request.form.get('head_ckpt'),&#10;        }&#10;&#10;        result = train_model(data)&#10;&#10;        if isinstance(result, dict):&#10;            return jsonify(result)&#10;        else:&#10;            return jsonify({'status': 'success', 'video_path': result})&#10;&#10;    return render_template('model_training.html')&#10;&#10;@app.route('/chat_system', methods=['GET', 'POST'])&#10;def chat_system():&#10;    if request.method == 'POST':&#10;        data = {&#10;            &quot;model_name&quot;: request.form.get('model_name'),&#10;            &quot;model_param&quot;: request.form.get('model_param'),&#10;            &quot;voice_clone&quot;: request.form.get('voice_clone'),&#10;            &quot;api_choice&quot;: request.form.get('api_choice'),&#10;            &quot;gpu_choice&quot;: request.form.get('gpu_choice'),&#10;            &quot;voice_clone_model&quot;: request.form.get('voice_clone_model'),&#10;            &quot;gf_torso_ckpt&quot;: request.form.get('gf_torso_ckpt'),&#10;            &quot;gf_head_ckpt&quot;: request.form.get('gf_head_ckpt'),&#10;        }&#10;&#10;        try:&#10;            result_path = chat_response(data)&#10;            # 统一路径格式为 Web 路径&#10;            if result_path:&#10;                result_path = &quot;/&quot; + result_path.replace(&quot;\\&quot;, &quot;/&quot;) if not result_path.startswith(&quot;/&quot;) else result_path&#10;            return jsonify({'status': 'success', 'video_path': result_path})&#10;        except Exception as e:&#10;            print(f&quot;Chat System Error: {e}&quot;)&#10;            return jsonify({'status': 'error', 'message': str(e)}), 500&#10;&#10;    return render_template('chat_system.html')&#10;&#10;# --- 功能接口 ---&#10;&#10;@app.route('/geneface/stop/&lt;task_id&gt;', methods=['POST'])&#10;def geneface_stop(task_id):&#10;    &quot;&quot;&quot;停止指定 ID 的训练任务&quot;&quot;&quot;&#10;    cmd = request.form.get('cmd', type=int)&#10;    # 注意：这里假设 stop_train_remote 接受 task_id 或 cmd，根据原逻辑调整&#10;    # 如果原逻辑是用 cmd 参数控制，这里保留原样&#10;    result = stop_train_remote(cmd)&#10;    &#10;    if isinstance(result, dict):&#10;        return jsonify(result)&#10;    else:&#10;        return jsonify({'status': 'success', 'message': str(result)})&#10;&#10;@app.route('/save_audio', methods=['POST'])&#10;def save_audio():&#10;    if 'audio' not in request.files:&#10;        return jsonify({'status': 'error', 'message': '没有音频文件'})&#10;&#10;    audio_file = request.files['audio']&#10;    if audio_file.filename == '':&#10;        return jsonify({'status': 'error', 'message': '没有选择文件'})&#10;&#10;    save_dir = os.path.join(BASE_DIR, 'io', &quot;history&quot;)&#10;    os.makedirs(save_dir, exist_ok=True)&#10;&#10;    raw_file_path = os.path.join(save_dir, 'aud_raw_from_browser')&#10;    audio_file.save(raw_file_path)&#10;&#10;    final_wav_path = os.path.join(save_dir, 'latest_user_aud.wav')&#10;&#10;    try:&#10;        print(f&quot;[app.py] 收到原始音频，正在从 {raw_file_path} 加载...&quot;)&#10;        audio = AudioSegment.from_file(raw_file_path)&#10;        &#10;        print(f&quot;[app.py] 正在重新导出为标准 WAV: {final_wav_path}&quot;)&#10;        # 强制转为单声道和16k采样率以兼容 ASR/RVC&#10;        audio = audio.set_channels(1).set_frame_rate(16000)&#10;        audio.export(final_wav_path, format=&quot;wav&quot;)&#10;        print(f&quot;[app.py] 音频保存并修复成功。&quot;)&#10;&#10;    except Exception as e:&#10;        print(f&quot;!!!!!!!!!!!!!! [app.py] 严重错误: 修复音频文件失败 !!!!!!!!!!!!!!&quot;)&#10;        print(f&quot;Error: {e}&quot;)&#10;        return jsonify({'status': 'error', 'message': f'后台处理音频文件失败 (请检查ffmpeg): {e}'}), 500&#10;    finally:&#10;        try:&#10;            if os.path.exists(raw_file_path):&#10;                os.remove(raw_file_path)&#10;        except Exception:&#10;            pass&#10;&#10;    # 返回给前端的路径可以不包含盘符，用于展示或调试&#10;    return jsonify({'status': 'success', 'message': '音频保存并修复成功', 'file_path': 'io/history/latest_user_aud.wav'})&#10;&#10;@app.route('/clear_history', methods=['POST'])&#10;def clear_history():&#10;    &quot;&quot;&quot;清除对话历史&quot;&quot;&quot;&#10;    success, msg = clear_chat_history()&#10;    if success:&#10;        return jsonify({'status': 'success', 'message': msg})&#10;    else:&#10;        return jsonify({'status': 'error', 'message': msg})&#10;&#10;@app.route('/list_ref_audios', methods=['GET'])&#10;def list_ref_audios():&#10;    &quot;&quot;&quot;列出 io/input/audio 下的参考音频&quot;&quot;&quot;&#10;    audio_dir = os.path.join(BASE_DIR, &quot;io&quot;, &quot;input&quot;, &quot;audio&quot;)&#10;    audios = []&#10;    if os.path.exists(audio_dir):&#10;        for f in os.listdir(audio_dir):&#10;            if f.lower().endswith(('.wav', '.mp3', '.m4a', '.flac')):&#10;                audios.append(f)&#10;    return jsonify(audios)&#10;&#10;@app.route('/upload_ref_audio', methods=['POST'])&#10;def upload_ref_audio():&#10;    &quot;&quot;&quot;上传参考音频 (增强版: 支持自动转码和UUID命名)&quot;&quot;&quot;&#10;    if 'audio' not in request.files:&#10;        return jsonify({'status': 'error', 'message': '请求中没有音频文件'})&#10;    &#10;    file = request.files['audio']&#10;    if file.filename == '':&#10;        return jsonify({'status': 'error', 'message': '未选择文件'})&#10;        &#10;    try:&#10;        # 1. 定义路径&#10;        temp_dir = os.path.join(BASE_DIR, 'io', 'temp')&#10;        final_dir = os.path.join(BASE_DIR, 'io', 'input', 'audio')&#10;        os.makedirs(temp_dir, exist_ok=True)&#10;        os.makedirs(final_dir, exist_ok=True)&#10;        &#10;        # 2. 保存原始文件到 temp (使用UUID防止中文名问题)&#10;        original_ext = os.path.splitext(file.filename)[1].lower()&#10;        if not original_ext: original_ext = &quot;.wav&quot;&#10;            &#10;        temp_filename = f&quot;upload_temp_{uuid.uuid4().hex}{original_ext}&quot;&#10;        temp_path = os.path.join(temp_dir, temp_filename)&#10;        file.save(temp_path)&#10;        &#10;        # 3. 准备最终文件名&#10;        original_stem = os.path.splitext(file.filename)[0]&#10;        # 尝试保留原始文件名主体，如果 secure_filename 变为空(如纯中文)，则生成随机名&#10;        safe_stem = secure_filename(original_stem)&#10;        if not safe_stem: &#10;            safe_stem = f&quot;ref_{uuid.uuid4().hex[:8]}&quot;&#10;            &#10;        final_filename = f&quot;{safe_stem}.wav&quot;&#10;        final_path = os.path.join(final_dir, final_filename)&#10;        &#10;        # 避免文件名冲突&#10;        counter = 1&#10;        while os.path.exists(final_path):&#10;            final_filename = f&quot;{safe_stem}_{counter}.wav&quot;&#10;            final_path = os.path.join(final_dir, final_filename)&#10;            counter += 1&#10;        &#10;        print(f&quot;[Upload] 正在转换: {temp_path} -&gt; {final_path}&quot;)&#10;        &#10;        # 4. 转换格式&#10;        try:&#10;            audio = AudioSegment.from_file(temp_path)&#10;            audio = audio.set_channels(1) # 转单声道&#10;            audio.export(final_path, format=&quot;wav&quot;)&#10;        except FileNotFoundError:&#10;            raise Exception(&quot;服务器未安装 ffmpeg，无法转换音频格式。&quot;)&#10;        except Exception as trans_e:&#10;            raise Exception(f&quot;音频转换失败: {trans_e}&quot;)&#10;        &#10;        # 5. 清理&#10;        if os.path.exists(temp_path):&#10;            os.remove(temp_path)&#10;            &#10;        print(f&quot;[Upload] 完成: {final_path}&quot;)&#10;        return jsonify({'status': 'success', 'filename': final_filename})&#10;        &#10;    except Exception as e:&#10;        print(f&quot;[Upload] Error: {e}&quot;)&#10;        # 尝试清理&#10;        if 'temp_path' in locals() and os.path.exists(temp_path):&#10;            try: os.remove(temp_path)&#10;            except: pass&#10;        return jsonify({'status': 'error', 'message': str(e)})&#10;&#10;# --- GeneFace++ 专用接口 ---&#10;&#10;@app.route('/geneface/health', methods=['GET'])&#10;def geneface_health_check():&#10;    &quot;&quot;&quot;检查 GeneFace++ 服务&quot;&quot;&quot;&#10;    is_ok = geneface_health()&#10;    return jsonify({&#10;        &quot;status&quot;: &quot;ok&quot; if is_ok else &quot;unavailable&quot;,&#10;        &quot;message&quot;: &quot;服务正常&quot; if is_ok else &quot;请启动 Docker: docker start geneface&quot;&#10;    })&#10;&#10;@app.route('/geneface/videos', methods=['GET'])&#10;def geneface_videos():&#10;    &quot;&quot;&quot;列出可用视频&quot;&quot;&quot;&#10;    return jsonify(geneface_api_call(&quot;/videos&quot;))&#10;&#10;@app.route('/geneface/upload', methods=['POST'])&#10;def geneface_upload():&#10;    &quot;&quot;&quot;上传视频到 GeneFace++&quot;&quot;&quot;&#10;    if 'video' not in request.files:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;没有视频文件&quot;}), 400&#10;&#10;    video_file = request.files['video']&#10;    video_id = request.form.get('video_id')&#10;&#10;    if not video_id:&#10;        video_id = os.path.splitext(secure_filename(video_file.filename))[0]&#10;&#10;    video_id = re.sub(r'[^a-zA-Z0-9_]', '_', video_id)&#10;&#10;    geneface_video_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;videos&quot;)&#10;    os.makedirs(geneface_video_dir, exist_ok=True)&#10;&#10;    save_path = os.path.join(geneface_video_dir, f&quot;{video_id}.mp4&quot;)&#10;    video_file.save(save_path)&#10;&#10;    return jsonify({&#10;        &quot;status&quot;: &quot;success&quot;,&#10;        &quot;video_id&quot;: video_id,&#10;        &quot;message&quot;: &quot;视频上传成功&quot;&#10;    })&#10;&#10;@app.route('/geneface/upload_audio', methods=['POST'])&#10;def geneface_upload_audio():&#10;    &quot;&quot;&quot;上传音频到 GeneFace++ 数据目录&quot;&quot;&quot;&#10;    if 'audio' not in request.files:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;没有音频文件&quot;}), 400&#10;&#10;    audio_file = request.files['audio']&#10;    audio_name = request.form.get('audio_name')&#10;&#10;    if not audio_name:&#10;        audio_name = os.path.splitext(secure_filename(audio_file.filename))[0]&#10;&#10;    # Ensure safe filename&#10;    audio_name = re.sub(r'[^a-zA-Z0-9_]', '_', audio_name)&#10;&#10;    # Target directory: GeneFace/data/raw/val_wavs&#10;    target_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;val_wavs&quot;)&#10;    os.makedirs(target_dir, exist_ok=True)&#10;&#10;    save_path = os.path.join(target_dir, f&quot;{audio_name}.wav&quot;)&#10;&#10;    try:&#10;        # Save to temp first&#10;        temp_path = os.path.join(target_dir, f&quot;temp_{audio_name}_{uuid.uuid4().hex}.tmp&quot;)&#10;        audio_file.save(temp_path)&#10;&#10;        # Convert to wav using pydub&#10;        audio = AudioSegment.from_file(temp_path)&#10;        audio.export(save_path, format=&quot;wav&quot;)&#10;&#10;        if os.path.exists(temp_path):&#10;            os.remove(temp_path)&#10;&#10;        return jsonify({&#10;            &quot;status&quot;: &quot;success&quot;,&#10;            &quot;message&quot;: &quot;音频上传成功&quot;,&#10;            &quot;path&quot;: save_path,&#10;            &quot;name&quot;: audio_name&#10;        })&#10;    except Exception as e:&#10;        return jsonify({&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: str(e)}), 500&#10;&#10;@app.route('/geneface/task/&lt;task_id&gt;', methods=['GET'])&#10;def geneface_task(task_id):&#10;    return jsonify(geneface_api_call(f&quot;/task/{task_id}&quot;))&#10;&#10;@app.route('/geneface/tasks', methods=['GET'])&#10;def geneface_tasks():&#10;    return jsonify(geneface_api_call(&quot;/tasks&quot;))&#10;&#10;@app.route('/geneface/models', methods=['GET'])&#10;def geneface_models():&#10;    &quot;&quot;&quot;列出已训练模型&quot;&quot;&quot;&#10;    models = []&#10;    ckpt_base = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;checkpoints&quot;, &quot;motion2video_nerf&quot;)&#10;&#10;    if os.path.exists(ckpt_base):&#10;        video_models = {}&#10;        for name in os.listdir(ckpt_base):&#10;            full_path = os.path.join(ckpt_base, name)&#10;            if os.path.isdir(full_path):&#10;                if name.endswith('_head'):&#10;                    video_id = name[:-5]&#10;                    if video_id not in video_models:&#10;                        video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                    for root, dirs, files in os.walk(full_path):&#10;                        for f in files:&#10;                            if f.endswith(('.ckpt', '.pt')):&#10;                                rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                                rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                                video_models[video_id][&quot;head_checkpoints&quot;].append(rel_path)&#10;                elif name.endswith('_torso'):&#10;                    video_id = name[:-6]&#10;                    if video_id not in video_models:&#10;                        video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                    for root, dirs, files in os.walk(full_path):&#10;                        for f in files:&#10;                            if f.endswith(('.ckpt', '.pt')):&#10;                                rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                                rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                                video_models[video_id][&quot;torso_checkpoints&quot;].append(rel_path)&#10;&#10;        for vid, data in video_models.items():&#10;            data[&quot;head_checkpoints&quot;].sort(key=lambda x: os.path.getmtime(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) if os.path.exists(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) else 0, reverse=True)&#10;            data[&quot;torso_checkpoints&quot;].sort(key=lambda x: os.path.getmtime(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) if os.path.exists(os.path.join(BASE_DIR, &quot;GeneFace&quot;, x)) else 0, reverse=True)&#10;&#10;        models = list(video_models.values())&#10;&#10;    return jsonify(models)&#10;&#10;@app.route('/geneface/models_local', methods=['GET'])&#10;def geneface_models_local():&#10;    &quot;&quot;&quot;扫描本地 GeneFace checkpoints 目录&quot;&quot;&quot;&#10;    checkpoints_dir = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;checkpoints&quot;, &quot;motion2video_nerf&quot;)&#10;    models = []&#10;&#10;    if os.path.exists(checkpoints_dir):&#10;        # 获取所有子文件夹&#10;        subdirs = [d for d in os.listdir(checkpoints_dir) if os.path.isdir(os.path.join(checkpoints_dir, d))]&#10;&#10;        for subdir in subdirs:&#10;            # 简单的过滤，通常我们关注 _torso 结尾的作为身体模型，但用户可能想要所有&#10;            # 这里我们列出所有文件夹，并扫描其中的 .ckpt/.pt 文件&#10;            dir_path = os.path.join(checkpoints_dir, subdir)&#10;            files = [f for f in os.listdir(dir_path) if f.endswith('.ckpt') or f.endswith('.pt')]&#10;&#10;            # 按修改时间排序，最新的在前&#10;            files.sort(key=lambda x: os.path.getmtime(os.path.join(dir_path, x)), reverse=True)&#10;&#10;            if files:&#10;                # 尝试推断对应的 head 文件夹&#10;                head_dir_name = subdir.replace(&quot;_torso&quot;, &quot;_head&quot;)&#10;                head_checkpoints = []&#10;                head_dir_path = os.path.join(checkpoints_dir, head_dir_name)&#10;                if os.path.exists(head_dir_path) and os.path.isdir(head_dir_path):&#10;                     head_files = [f for f in os.listdir(head_dir_path) if f.endswith('.ckpt') or f.endswith('.pt')]&#10;                     head_files.sort(key=lambda x: os.path.getmtime(os.path.join(head_dir_path, x)), reverse=True)&#10;                     head_checkpoints = [os.path.join(&quot;checkpoints&quot;, &quot;motion2video_nerf&quot;, head_dir_name, f).replace(&quot;\\&quot;, &quot;/&quot;) for f in head_files]&#10;&#10;                models.append({&#10;                    &quot;video_id&quot;: subdir, # 这里用文件夹名作为 ID&#10;                    &quot;torso_checkpoints&quot;: [os.path.join(&quot;checkpoints&quot;, &quot;motion2video_nerf&quot;, subdir, f).replace(&quot;\\&quot;, &quot;/&quot;) for f in files],&#10;                    &quot;head_checkpoints&quot;: head_checkpoints&#10;                })&#10;&#10;    return jsonify(models)&#10;&#10;@app.route('/geneface/video/&lt;video_id&gt;')&#10;def geneface_video_file(video_id):&#10;    video_id = re.sub(r'[^a-zA-Z0-9_-]', '', video_id)&#10;    video_path = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;data&quot;, &quot;raw&quot;, &quot;videos&quot;, f&quot;{video_id}.mp4&quot;)&#10;    if os.path.exists(video_path):&#10;        return send_file(video_path, mimetype='video/mp4')&#10;    else:&#10;        return jsonify({&quot;error&quot;: &quot;视频不存在&quot;}), 404&#10;&#10;@app.route('/geneface/audios', methods=['GET'])&#10;def geneface_audios():&#10;    return jsonify(geneface_api_call(&quot;/audios&quot;))&#10;&#10;&#10;if __name__ == '__main__':&#10;    app.run(host='0.0.0.0', debug=True, port=5000, use_reloader=False)&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;&#10;@app.route('/geneface/infer', methods=['POST'])&#10;def geneface_infer():&#10;    data = request.json&#10;    return jsonify(geneface_api_call(&quot;/infer&quot;, &quot;POST&quot;, data))&#10;&#10;@app.route('/geneface/output/&lt;path:filename&gt;')&#10;def geneface_output_file(filename):&#10;    filename = secure_filename(filename)&#10;    video_path = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;infer_out&quot;, filename)&#10;    if os.path.exists(video_path):&#10;        return send_file(video_path, mimetype='video/mp4')&#10;    else:&#10;        return jsonify({&quot;error&quot;: &quot;视频不存在&quot;}), 404&#10;&#10;if __name__ == '__main__':&#10;    app.run(host='0.0.0.0', debug=True, port=5000, use_reloader=False)" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/debug_models.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/debug_models.py" />
              <option name="updatedContent" value="&#10;import os&#10;import json&#10;&#10;BASE_DIR = os.getcwd()&#10;ckpt_base = os.path.join(BASE_DIR, &quot;GeneFace&quot;, &quot;checkpoints&quot;, &quot;motion2video_nerf&quot;)&#10;&#10;print(f&quot;Checking base dir: {ckpt_base}&quot;)&#10;&#10;models = []&#10;&#10;if os.path.exists(ckpt_base):&#10;    video_models = {}&#10;    for name in os.listdir(ckpt_base):&#10;        full_path = os.path.join(ckpt_base, name)&#10;        if os.path.isdir(full_path):&#10;            if name.endswith('_head'):&#10;                video_id = name[:-5]&#10;                if video_id not in video_models:&#10;                    video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                for root, dirs, files in os.walk(full_path):&#10;                    for f in files:&#10;                        if f.endswith(('.ckpt', '.pt')):&#10;                            rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                            rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                            video_models[video_id][&quot;head_checkpoints&quot;].append(rel_path)&#10;            elif name.endswith('_torso'):&#10;                video_id = name[:-6]&#10;                if video_id not in video_models:&#10;                    video_models[video_id] = {&quot;video_id&quot;: video_id, &quot;head_checkpoints&quot;: [], &quot;torso_checkpoints&quot;: []}&#10;                for root, dirs, files in os.walk(full_path):&#10;                    for f in files:&#10;                        if f.endswith(('.ckpt', '.pt')):&#10;                            rel_path = os.path.relpath(os.path.join(root, f), os.path.join(BASE_DIR, &quot;GeneFace&quot;))&#10;                            rel_path = rel_path.replace(&quot;\\&quot;, &quot;/&quot;)&#10;                            video_models[video_id][&quot;torso_checkpoints&quot;].append(rel_path)&#10;&#10;    for vid, data in video_models.items():&#10;        # Sort&#10;        pass&#10;&#10;    models = list(video_models.values())&#10;&#10;print(json.dumps(models, indent=2))&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>