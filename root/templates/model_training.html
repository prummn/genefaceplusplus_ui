<!-- templates/model_training.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>模型训练界面</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/instruction.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/model_training.css') }}">
</head>

<body class="subpage-bg">

    <button onclick="window.location.href='/'" class="back-btn">← 返回</button>
    <button class="vg-help-button" id="vg_openHelpBtn">使用教程</button>
    <div class="vg-modal-backdrop" id="vg_helpModal" role="dialog" aria-modal="true" aria-labelledby="vg_helpTitle" tabindex="-1" hidden>
        <div class="vg-modal-content" role="document">
            <div class="vg-modal-header">
                <h2 class="vg-modal-title" id="vg_helpTitle">使用教程</h2>
                <button class="vg-modal-close" id="vg_closeHelpBtn" aria-label="关闭">✕</button>
            </div>

            <pre id="vg_helpBody" class="vg-modal-body" tabindex="0" data-src="{{ url_for('static', filename='text/model_training.txt') }}"></pre>

            <div class="vg-modal-actions" aria-hidden="false">
                <button class="vg-btn vg-btn-primary" id="vg_playTutorialBtn" type="button"
                        data-video="{{ url_for('static', filename='videos/model_training.mp4') }}">
                    播放教程视频
                </button>
            </div>
        </div>
    </div>
    <div class="page-container">
        <h2>模型训练界面</h2>
        <div class="video-page-container">
            <!-- 左侧 -->
            <div class="video-display">
                <video id="trainVideo" controls>
                    <source id="videoSource" src="" type="video/mp4">
                </video>

                <!-- 任务状态 - 深色主题 -->
                <div id="taskStatus" class="task-status">
                    <div class="status-row">
                        <span class="label">任务 ID:</span>
                        <span class="value" id="taskId">-</span>
                    </div>
                    <div class="status-row">
                        <span class="label">状态:</span>
                        <span class="value" id="taskState">-</span>
                    </div>
                    <div class="status-row">
                        <span class="label">当前步骤:</span>
                        <span class="value" id="taskStep">-</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
                    </div>
                    <div class="status-row" style="margin-top: 12px;">
                        <span class="label">消息:</span>
                        <span class="value" id="taskMessage">-</span>
                    </div>
                </div>

                <!-- 日志 -->
                <div id="logContainer" class="log-container">
                    <div class="log-header">📋 训练日志</div>
                    <div id="logContent"></div>
                </div>
            </div>

            <!-- 右侧表单 -->
            <div class="form-section">
                <form id="trainForm">
                    <div class="form-group">
                        <label>模型选择</label>
                        <select name="model_choice" id="model_choice" onchange="toggleModelOptions()">
                            <option value="SyncTalk">SyncTalk</option>
                            <option value="GeneFace++" selected>GeneFace++</option>
                        </select>
                    </div>

                    <div id="synctalk_options" style="display: none;">
                        <div class="form-group">
                            <label>参考视频地址</label>
                            <input type="text" name="ref_video" placeholder="请输入视频路径">
                        </div>
                        <div class="form-group">
                            <label>Epoch</label>
                            <input type="number" name="epoch" min="1" value="10">
                        </div>
                    </div>

                    <div id="geneface_options" >
                        <div class="form-group">
                            <label>视频来源</label>
                            <select id="video_source" onchange="toggleVideoSource()">
                                <option value="existing">选择已有视频</option>
                                <option value="upload">上传新视频</option>
                            </select>
                        </div>

                        <div class="form-group" id="existing_video_group">
                            <label>选择视频</label>
                            <select name="video_id" id="video_select" onchange="onVideoSelected()">
                                <option value="">-- 请选择 --</option>
                            </select>
                            <button type="button" onclick="refreshVideoList()" class="refresh-btn">⟳ 刷新列表</button>
                        </div>

                        <div class="form-group" id="upload_video_group" style="display: none;">
                            <label>上传视频 (MP4)</label>
                            
                            <!-- 1. 美化的文件选择器 -->
                            <div class="file-input-container">
                                <!-- 隐藏原生 input -->
                                <input type="file" id="video_file" accept="video/mp4" class="hidden-input" onchange="updateFileName(this)">
                                
                                <!-- 自定义外观按钮 -->
                                <label for="video_file" class="custom-file-btn">
                                    📂 点击选择视频
                                </label>
                                
                                <!-- 显示文件名 -->
                                <span id="file_name_display" class="file-name-text">未选择文件</span>
                            </div>

                            <!-- 2. Video ID 输入框 -->
                            <input type="text" id="new_video_id" class="styled-input" placeholder="请输入 Video ID (例如: may_test)">

                            <!-- 3. 上传确认按钮 -->
                            <button type="button" onclick="uploadVideo()" class="upload-action-btn">
                                ⬆ 确认上传
                            </button>
                            
                            <!-- 状态显示 -->
                            <span id="upload_status" class="upload-status"></span>
                        </div>

                        <div class="form-group">
                            <label>训练阶段</label>
                            <select name="train_stage" id="train_stage" onchange="onTrainStageChange()">
                                <option value="preprocess">1. 数据预处理</option>
                                <option value="head">2. 头部模型训练</option>
                                <option value="torso">3. 身体模型训练</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>训练步数 (Total Steps)</label>
                            <input type="number" name="max_updates_head" placeholder="头部训练总步数 (默认 250000)" value="250000">
                            <input type="number" name="max_updates_torso" placeholder="身体训练总步数 (默认 250000)" value="250000" style="margin-top: 5px;">
                            <small style="color: #888; display: block; margin-top: 5px;">注意：这是累计总步数。如果断点续训，请设置比当前步数更大的值。</small>
                        </div>

                        <div class="form-group" id="head_ckpt_group" style="display: none;">
                            <label>Head Checkpoint (用于身体训练)</label>
                            <select name="head_ckpt" id="head_ckpt_select">
                                <option value="">-- 请先选择视频 --</option>
                            </select>
                            <div style="font-size: 12px; color: #888; margin-top: 4px;">
                                * 将自动加载对应视频 ID 下的头部模型
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>GPU选择</label>
                        <select name="gpu_choice">
                            <option value="GPU0">GPU 0</option>
                            <option value="GPU1">GPU 1</option>
                        </select>
                    </div>
					
					<div class="btn-group">
						<button type="submit" class="generate-btn" id="submitBtn">开始训练</button>
						<button type="button" class="generate-btn stop-btn" id="stopBtn" style="display: none; background: #e57373;">停止训练</button>
					</div>
					
                    <!--<button type="submit" class="generate-btn" id="submitBtn">开始训练</button>-->
                </form>

                <div id="geneface_status" style="margin-top: 10px; ">
                    <span id="service_status"></span>
                </div>
            </div>
        </div>
    </div>
    <script src="{{ url_for('static', filename='js/model_training.js') }}"></script>
    <script src="{{ url_for('static', filename='js/instruction.js') }}"></script>
</body>
</html>