<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘ç”Ÿæˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video_generation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/instruction.css') }}">
    <style>
        /* GeneFace++ ä¸“ç”¨æ ·å¼ */
        .geneface-options { display: none; }
        .geneface-options.active { display: block; }
        .audio-source-group {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        /* æ–°å¢ï¼šæ–‡æœ¬ç”ŸæˆéŸ³é¢‘çš„é«˜äº®æ ·å¼ */
        .text-gen-group {
            margin: 10px 0;
            padding: 10px;
            background: rgba(79, 195, 247, 0.1); /* æ·¡è“è‰²èƒŒæ™¯ */
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
        }
        .upload-status { font-size: 12px; margin-top: 5px; }
        .upload-status.success { color: #81c784; }
        .upload-status.error { color: #e57373; }
        .model-info { font-size: 12px; color: #888; margin-top: 5px; }
        .refresh-btn { padding: 5px 10px; margin-left: 10px; cursor: pointer; }
        .generating-status {
            padding: 15px; background: #1a1a2e; border-radius: 8px; margin-top: 15px; display: none;
        }
        .generating-status.active { display: block; }
        .generating-status .spinner {
            display: inline-block; width: 20px; height: 20px; border: 2px solid #4fc3f7;
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite; margin-right: 10px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        body, html {
            height: auto !important;
            overflow-y: auto !important;
        }

        .page-container {
            height: auto !important;
            min-height: 100vh;
            padding-bottom: 100px; /* åº•éƒ¨å¤šç•™ç‚¹ç©ºé—´ */
        }

        .video-page-container {
            height: auto !important;
            align-items: flex-start; /* é˜²æ­¢å­å…ƒç´ å¼ºåˆ¶ç­‰é«˜ */
        }

        .form-section {
            /* ç§»é™¤å¯èƒ½å­˜åœ¨çš„å›ºå®šé«˜åº¦é™åˆ¶ */
            height: auto !important;
            max-height: none !important;
            overflow: visible !important;
        }
    </style>
</head>

<body class="subpage-bg">

    <button onclick="window.location.href='/'" aria-label="è¿”å›é¦–é¡µ" title="è¿”å›é¦–é¡µ" class="back-btn">â† è¿”å›</button>
    <button class="vg-help-button" id="vg_openHelpBtn" aria-haspopup="dialog" aria-controls="vg_helpModal">å‚æ•°è¯´æ˜</button>

    <div class="page-container">
        <h2>è§†é¢‘ç”Ÿæˆ</h2>

        <div class="video-page-container">
            <!-- å·¦ä¾§ï¼šé¢„è§ˆ/ç”Ÿæˆè§†é¢‘åŒºåŸŸ -->
            <div class="video-display">
                <video id="previewVideo" controls width="420">
                    <source id="videoSource" src="{{ url_for('static', filename=default_video) }}" type="video/mp4">
                </video>
                <div id="generatingStatus" class="generating-status">
                    <span class="spinner"></span>
                    <span id="statusText">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</span>
                </div>
            </div>

            <!-- å³è¾¹è¾“å…¥è¡¨å• -->
            <div class="form-section">
                <form id="videoForm">
                    <div class="form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <select name="model_name" id="model_name" onchange="toggleModelOptions()">
                            <option value="SyncTalk">SyncTalk</option>
                            <option value="GeneFace++">GeneFace++</option>
                        </select>
                    </div>

                    <!-- å…¬å…±éŸ³é¢‘é©±åŠ¨è®¾ç½® (ä¿®æ”¹éƒ¨åˆ†) -->
                    <div class="form-group">
                        <label>é©±åŠ¨æ–¹å¼</label>
                        <select id="drive_mode" onchange="toggleDriveMode()">
                            <option value="audio_file">ä½¿ç”¨éŸ³é¢‘æ–‡ä»¶</option>
                            <option value="text_gen">æ–‡æœ¬ç”Ÿæˆè¯­éŸ³ (RVC)</option>
                        </select>
                    </div>

                    <!-- æ–¹å¼A: æ–‡æœ¬ç”Ÿæˆè¯­éŸ³ (æ–°å¢) -->
                    <div id="text_gen_options" class="text-gen-group" style="display: none;">
                        <div class="form-group">
                            <label>è¾“å…¥æ–‡æœ¬ (å°†å…‹éš†ä¸ºè¯­éŸ³)</label>
                            <textarea name="target_text" id="target_text" rows="3" placeholder="è¯·è¾“å…¥è¦è®©æ•°å­—äººè¯´çš„è¯..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©éŸ³è‰² (RVC)</label>
                            <select name="voice_clone" id="voice_clone">
                                <option value="zhb">zhb - é»˜è®¤ç”·å£°</option>
                                <option value="nahida">nahida - çº³è¥¿å¦²</option>
                                <!-- å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤š -->
                            </select>
                        </div>
                    </div>

                    <!-- æ–¹å¼B: éŸ³é¢‘æ–‡ä»¶ (åŸæœ‰çš„é€»è¾‘) -->
                    <div id="audio_file_options">
                        <!-- SyncTalk çš„éŸ³é¢‘è¾“å…¥ -->
                        <div id="synctalk_audio_input" class="form-group">
                            <label>å‚è€ƒéŸ³é¢‘åœ°å€</label>
                            <input type="text" name="ref_audio" placeholder="è¯·è¾“å…¥éŸ³é¢‘è·¯å¾„">
                        </div>

                        <!-- GeneFace çš„éŸ³é¢‘è¾“å…¥ (åŒ…å«ä¸Šä¼ /é€‰æ‹©) -->
                        <div id="geneface_audio_input" class="geneface-options">
                            <div class="form-group">
                                <label>éŸ³é¢‘æ¥æº</label>
                                <select id="audio_source" onchange="toggleAudioSource()">
                                    <option value="existing">é€‰æ‹©å·²æœ‰éŸ³é¢‘</option>
                                    <option value="upload">ä¸Šä¼ æ–°éŸ³é¢‘</option>
                                </select>
                            </div>
                            <div class="audio-source-group" id="existing_audio_group">
                                <label>é€‰æ‹©éŸ³é¢‘ <button type="button" class="refresh-btn" onclick="refreshAudios()">ğŸ”„</button></label>
                                <select name="gf_audio" id="gf_audio_select">
                                    <option value="">-- è¯·é€‰æ‹© --</option>
                                </select>
                            </div>
                            <div class="audio-source-group" id="upload_audio_group" style="display: none;">
                                <label>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ (WAV/MP3)</label>
                                <input type="file" id="audio_file" accept=".wav,.mp3,.m4a">
                                <input type="text" id="audio_name" placeholder="éŸ³é¢‘åç§°ï¼ˆå¯é€‰ï¼‰" style="margin-top: 5px;">
                                <button type="button" onclick="uploadAudio()" style="margin-top: 5px;">ä¸Šä¼ </button>
                                <div id="audio_upload_status" class="upload-status"></div>
                            </div>
                        </div>
                    </div>

                    <!-- SyncTalk é€‰é¡¹ -->
                    <div id="synctalk_options">
                        <div class="form-group">
                            <label>æ¨¡å‹ç›®å½•åœ°å€</label>
                            <input type="text" name="model_param" placeholder="è¯·è¾“å…¥æ¨¡å‹ç›®å½•è·¯å¾„">
                        </div>
                    </div>

                    <!-- GeneFace++ é€‰é¡¹ -->
                    <div id="geneface_options" class="geneface-options">
                        <div class="form-group">
                            <span id="gf_service_status" style="font-size: 12px;">æ£€æŸ¥æœåŠ¡ä¸­...</span>
                        </div>
                        <div class="form-group">
                            <label>é€‰æ‹©è§’è‰² (Video ID) <button type="button" class="refresh-btn" onclick="refreshModels()">ğŸ”„ åˆ·æ–°</button></label>
                            <select id="gf_video_id_select" onchange="onVideoIdSelected()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¤´éƒ¨æ¨¡å‹ (Head Checkpoint)</label>
                            <select name="gf_head_ckpt" id="gf_head_ckpt_select"><option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option></select>
                        </div>
                        <div class="form-group">
                            <label>èº«ä½“æ¨¡å‹ (Torso Checkpoint)</label>
                            <select name="gf_torso_ckpt" id="gf_torso_ckpt_select"><option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option></select>
                        </div>
                        <input type="hidden" name="gf_audio_path" id="gf_audio_path">
                    </div>

                    <div class="form-group">
                        <label>GPUé€‰æ‹©</label>
                        <select name="gpu_choice">
                            <option value="GPU0">GPU 0</option>
                            <option value="GPU1">GPU 1</option>
                        </select>
                    </div>

                    <button type="submit" class="generate-btn" id="submitBtn">ç”Ÿæˆè§†é¢‘</button>
                </form>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†ä»£ç çœç•¥ï¼Œä¿æŒä¸å˜ -->
    <!-- ... -->

    <script>
    // ==================== ç•Œé¢äº¤äº’é€»è¾‘ ====================

    let genefaceModels = {};

    function toggleDriveMode() {
        const mode = document.getElementById('drive_mode').value;
        const textOpts = document.getElementById('text_gen_options');
        const audioOpts = document.getElementById('audio_file_options');

        if (mode === 'text_gen') {
            textOpts.style.display = 'block';
            audioOpts.style.display = 'none';
        } else {
            textOpts.style.display = 'none';
            audioOpts.style.display = 'block';
        }
    }

    function toggleModelOptions() {
        const choice = document.getElementById('model_name').value;
        const synctalkOpts = document.getElementById('synctalk_options');
        const genefaceOpts = document.getElementById('geneface_options'); // å‚æ•°éƒ¨åˆ†
        const genefaceAudioInput = document.getElementById('geneface_audio_input'); // éŸ³é¢‘è¾“å…¥éƒ¨åˆ†
        const synctalkAudioInput = document.getElementById('synctalk_audio_input'); // SyncTalkéŸ³é¢‘è¾“å…¥

        if (choice === 'GeneFace++') {
            synctalkOpts.style.display = 'none';
            synctalkAudioInput.style.display = 'none';

            genefaceOpts.classList.add('active');
            genefaceAudioInput.classList.add('active');

            checkGenefaceHealth();
            refreshModels();
            refreshAudios();
        } else {
            synctalkOpts.style.display = 'block';
            synctalkAudioInput.style.display = 'block';

            genefaceOpts.classList.remove('active');
            genefaceAudioInput.classList.remove('active');
        }
    }

    // ... (checkGenefaceHealth, refreshModels, onVideoIdSelected, refreshAudios, toggleAudioSource, uploadAudio ä¿æŒä¸å˜) ...
    // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œæ­¤å¤„çœç•¥é‡å¤çš„ JS å‡½æ•°ï¼Œè¯·ä¿ç•™ä¹‹å‰å®ç°çš„è¿™äº›å‡½æ•°é€»è¾‘
    function checkGenefaceHealth() { /* ... */ fetch('/geneface/health').then(r=>r.json()).then(d=>{document.getElementById('gf_service_status').innerHTML=d.status==='ok'?'âœ“ æ­£å¸¸':'âœ— '+d.message}).catch(()=>{document.getElementById('gf_service_status').innerHTML='âœ— æ— æ³•è¿æ¥'}); }
    function refreshModels() { /* ... */ const s=document.getElementById('gf_video_id_select');s.innerHTML='<option>Loading...</option>';fetch('/geneface/models').then(r=>r.json()).then(d=>{genefaceModels={};s.innerHTML='<option value="">-- è¯·é€‰æ‹© --</option>';d.forEach(m=>{genefaceModels[m.video_id]=m;const o=document.createElement('option');o.value=m.video_id;o.textContent=m.video_id;s.appendChild(o)})}); }
    function onVideoIdSelected() { /* ... */ const v=document.getElementById('gf_video_id_select').value;const h=document.getElementById('gf_head_ckpt_select');const t=document.getElementById('gf_torso_ckpt_select');h.innerHTML='';t.innerHTML='';if(v&&genefaceModels[v]){const d=genefaceModels[v];(d.head_checkpoints||[]).forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p.split('/').pop();h.appendChild(o)});(d.torso_checkpoints||[]).forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p.split('/').pop();t.appendChild(o)});if(t.options.length>0)t.selectedIndex=0;if(h.options.length>0)h.selectedIndex=0} }
    function refreshAudios() { /* ... */ const s=document.getElementById('gf_audio_select');fetch('/geneface/audios').then(r=>r.json()).then(d=>{s.innerHTML='<option value="">-- è¯·é€‰æ‹© --</option>';d.forEach(a=>{const o=document.createElement('option');o.value=a.path;o.textContent=a.name;s.appendChild(o)})}) }
    function toggleAudioSource() { /* ... */ const s=document.getElementById('audio_source').value;document.getElementById('existing_audio_group').style.display=s==='existing'?'block':'none';document.getElementById('upload_audio_group').style.display=s==='upload'?'block':'none' }
    function uploadAudio() { /* ... */ /* ä¿ç•™ä¹‹å‰çš„ä¸Šä¼ é€»è¾‘ */ }


    // ==================== è¡¨å•æäº¤ ====================

    document.getElementById('videoForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const modelName = document.getElementById('model_name').value;
        const driveMode = document.getElementById('drive_mode').value;
        const formData = new FormData(this);

        // æ ¡éªŒé€»è¾‘
        if (driveMode === 'text_gen') {
            const text = document.getElementById('target_text').value;
            if (!text.trim()) {
                alert('è¯·è¾“å…¥è¦ç”Ÿæˆçš„æ–‡æœ¬');
                return;
            }
            // æ¸…ç©ºæ–‡ä»¶éŸ³é¢‘è·¯å¾„ï¼Œç¡®ä¿åç«¯ä½¿ç”¨æ–‡æœ¬ç”Ÿæˆ
            formData.set('gf_audio_path', '');
            formData.set('ref_audio', '');
        } else {
            // éŸ³é¢‘æ–‡ä»¶æ¨¡å¼
            formData.set('target_text', ''); // æ¸…ç©ºæ–‡æœ¬ï¼Œç¡®ä¿åç«¯ä¸ç”Ÿæˆ

            if (modelName === 'GeneFace++') {
                const headCkpt = document.getElementById('gf_head_ckpt_select').value;
                const torsoCkpt = document.getElementById('gf_torso_ckpt_select').value;
                if (!headCkpt || !torsoCkpt) { alert('è¯·é€‰æ‹©æ¨¡å‹'); return; }

                let audioPath = '';
                const audioSource = document.getElementById('audio_source').value;
                if (audioSource === 'existing') audioPath = document.getElementById('gf_audio_select').value;

                if (!audioPath) { alert('è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶'); return; }
                formData.set('gf_audio_path', audioPath);
            }
        }

        // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€
        document.getElementById('generatingStatus').classList.add('active');
        document.getElementById('statusText').textContent = driveMode === 'text_gen' ? 'æ­£åœ¨å…‹éš†è¯­éŸ³...' : 'æ­£åœ¨ç”Ÿæˆè§†é¢‘...';
        document.getElementById('submitBtn').disabled = true;

        fetch('/video_generation', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('generatingStatus').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;

            if (data.status === 'success' && data.video_path) {
                const videoEl = document.getElementById('previewVideo');
                const sourceEl = document.getElementById('videoSource');
                sourceEl.src = '/' + data.video_path + '?t=' + Date.now();
                videoEl.load();
                videoEl.play();
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(e => {
            document.getElementById('generatingStatus').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;
            alert('è¯·æ±‚å¤±è´¥: ' + e.message);
        });
    });
    </script>
    <script src="{{ url_for('static', filename='js/instruction.js') }}"></script>
</body>
</html>