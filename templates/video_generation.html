<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>è§†é¢‘ç”Ÿæˆ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video_generation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/instruction.css') }}">
    <style>
        /* GeneFace++ ä¸“ç”¨æ ·å¼ */
        .geneface-options {
            display: none;
        }
        .geneface-options.active {
            display: block;
        }
        .audio-source-group {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .upload-status {
            font-size: 12px;
            margin-top: 5px;
        }
        .upload-status.success { color: #81c784; }
        .upload-status.error { color: #e57373; }
        .model-info {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        .refresh-btn {
            padding: 5px 10px;
            margin-left: 10px;
            cursor: pointer;
        }
        .generating-status {
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            margin-top: 15px;
            display: none;
        }
        .generating-status.active {
            display: block;
        }
        .generating-status .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4fc3f7;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>

<body class="subpage-bg">

    <button onclick="window.location.href='/'" aria-label="è¿”å›é¦–é¡µ" title="è¿”å›é¦–é¡µ" class="back-btn">
        â† è¿”å›
    </button>

    <button class="vg-help-button" id="vg_openHelpBtn" aria-haspopup="dialog" aria-controls="vg_helpModal">å‚æ•°è¯´æ˜</button>

    <div class="page-container">
        <h2>è§†é¢‘ç”Ÿæˆ</h2>

        <div class="video-page-container">
            <!-- å·¦ä¾§ï¼šé¢„è§ˆ/ç”Ÿæˆè§†é¢‘åŒºåŸŸ -->
            <div class="video-display">
                <video id="previewVideo" controls width="420">
                    <source id="videoSource" src="{{ url_for('static', filename=default_video) }}" type="video/mp4">
                </video>

                <!-- ç”ŸæˆçŠ¶æ€ -->
                <div id="generatingStatus" class="generating-status">
                    <span class="spinner"></span>
                    <span id="statusText">æ­£åœ¨ç”Ÿæˆè§†é¢‘...</span>
                </div>
            </div>

            <!-- å³è¾¹è¾“å…¥è¡¨å• -->
            <div class="form-section">
                <form id="videoForm">
                    <div class="form-group">
                        <label>æ¨¡å‹åç§°</label>
                        <select name="model_name" id="model_name" onchange="toggleModelOptions()">
                            <option value="SyncTalk">SyncTalk</option>
                            <option value="GeneFace++">GeneFace++</option>
                        </select>
                    </div>

                    <!-- SyncTalk é€‰é¡¹ -->
                    <div id="synctalk_options">
                        <div class="form-group">
                            <label>æ¨¡å‹ç›®å½•åœ°å€</label>
                            <input type="text" name="model_param" placeholder="è¯·è¾“å…¥æ¨¡å‹ç›®å½•è·¯å¾„">
                        </div>

                        <div class="form-group">
                            <label>å‚è€ƒéŸ³é¢‘åœ°å€</label>
                            <input type="text" name="ref_audio" placeholder="è¯·è¾“å…¥éŸ³é¢‘è·¯å¾„">
                        </div>

                        <div class="form-group">
                            <label>ç›®æ ‡æ–‡å­—ï¼ˆæ–‡æœ¬æ¡†ï¼‰</label>
                            <textarea name="target_text" placeholder="ç•™ç©ºåˆ™ç›´æ¥ä½¿ç”¨å‚è€ƒéŸ³é¢‘"></textarea>
                        </div>
                    </div>

                    <!-- GeneFace++ é€‰é¡¹ -->
                    <div id="geneface_options" class="geneface-options">
                        <!-- æœåŠ¡çŠ¶æ€ -->
                        <div class="form-group">
                            <span id="gf_service_status" style="font-size: 12px;">æ£€æŸ¥æœåŠ¡ä¸­...</span>
                        </div>

                        <!-- æ¨¡å‹é€‰æ‹©åŒºåŸŸ (å·²ä¿®æ”¹) -->
                        <div class="form-group">
                            <label>é€‰æ‹©è§’è‰² (Video ID)
                                <button type="button" class="refresh-btn" onclick="refreshModels()">ğŸ”„ åˆ·æ–°</button>
                            </label>
                            <select id="gf_video_id_select" onchange="onVideoIdSelected()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>å¤´éƒ¨æ¨¡å‹ (Head Checkpoint)</label>
                            <select name="gf_head_ckpt" id="gf_head_ckpt_select">
                                <option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>èº«ä½“æ¨¡å‹ (Torso Checkpoint)</label>
                            <select name="gf_torso_ckpt" id="gf_torso_ckpt_select">
                                <option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option>
                            </select>
                        </div>

                        <!-- éŸ³é¢‘æ¥æº -->
                        <div class="form-group">
                            <label>éŸ³é¢‘æ¥æº</label>
                            <select id="audio_source" onchange="toggleAudioSource()">
                                <option value="existing">é€‰æ‹©å·²æœ‰éŸ³é¢‘</option>
                                <option value="upload">ä¸Šä¼ æ–°éŸ³é¢‘</option>
                            </select>
                        </div>

                        <!-- å·²æœ‰éŸ³é¢‘é€‰æ‹© -->
                        <div class="audio-source-group" id="existing_audio_group">
                            <label>é€‰æ‹©éŸ³é¢‘
                                <button type="button" class="refresh-btn" onclick="refreshAudios()">ğŸ”„</button>
                            </label>
                            <select name="gf_audio" id="gf_audio_select">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                            </select>
                        </div>

                        <!-- ä¸Šä¼ éŸ³é¢‘ -->
                        <div class="audio-source-group" id="upload_audio_group" style="display: none;">
                            <label>ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ (WAV/MP3)</label>
                            <input type="file" id="audio_file" accept=".wav,.mp3,.m4a">
                            <input type="text" id="audio_name" placeholder="éŸ³é¢‘åç§°ï¼ˆå¯é€‰ï¼‰" style="margin-top: 5px;">
                            <button type="button" onclick="uploadAudio()" style="margin-top: 5px;">ä¸Šä¼ </button>
                            <div id="audio_upload_status" class="upload-status"></div>
                        </div>

                        <input type="hidden" name="gf_audio_path" id="gf_audio_path">
                    </div>

                    <div class="form-group">
                        <label>GPUé€‰æ‹©</label>
                        <select name="gpu_choice">
                            <option value="GPU0">GPU 0</option>
                            <option value="GPU1">GPU 1</option>
                        </select>
                    </div>

                    <button type="submit" class="generate-btn" id="submitBtn">ç”Ÿæˆè§†é¢‘</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Modal Omitted for Brevity, same as before -->
    <div class="vg-modal-backdrop" id="vg_helpModal" role="dialog" aria-modal="true" aria-labelledby="vg_helpTitle" tabindex="-1" hidden>
        <div class="vg-modal-content" role="document">
            <div class="vg-modal-header">
                <h2 class="vg-modal-title" id="vg_helpTitle">å‚æ•°è¯´æ˜</h2>
                <button class="vg-modal-close" id="vg_closeHelpBtn" aria-label="å…³é—­">âœ•</button>
            </div>
            <pre id="vg_helpBody" class="vg-modal-body" tabindex="0" data-src="{{ url_for('static', filename='text/video_generation.txt') }}"></pre>
            <div class="vg-modal-actions" aria-hidden="false">
                <button class="vg-btn vg-btn-primary" id="vg_playTutorialBtn" type="button"
                        data-video="{{ url_for('static', filename='videos/tutorial.mp4') }}">
                    æ’­æ”¾æ•™ç¨‹è§†é¢‘
                </button>
            </div>
        </div>
    </div>

    <script>
    // ==================== GeneFace++ åŠŸèƒ½ ====================

    let genefaceModels = {};

    function toggleModelOptions() {
        const choice = document.getElementById('model_name').value;
        const synctalkOpts = document.getElementById('synctalk_options');
        const genefaceOpts = document.getElementById('geneface_options');

        if (choice === 'GeneFace++') {
            synctalkOpts.style.display = 'none';
            genefaceOpts.classList.add('active');
            checkGenefaceHealth();
            refreshModels();
            refreshAudios();
        } else {
            synctalkOpts.style.display = 'block';
            genefaceOpts.classList.remove('active');
        }
    }

    function checkGenefaceHealth() {
        fetch('/geneface/health')
            .then(r => r.json())
            .then(data => {
                const el = document.getElementById('gf_service_status');
                if (data.status === 'ok') {
                    el.innerHTML = 'âœ“ GeneFace++ æœåŠ¡æ­£å¸¸';
                    el.style.color = '#81c784';
                } else {
                    el.innerHTML = 'âœ— ' + data.message;
                    el.style.color = '#e57373';
                }
            })
            .catch(() => {
                const el = document.getElementById('gf_service_status');
                el.innerHTML = 'âœ— æ— æ³•è¿æ¥æœåŠ¡';
                el.style.color = '#e57373';
            });
    }

    function refreshModels() {
        const videoSelect = document.getElementById('gf_video_id_select');
        videoSelect.innerHTML = '<option value="">-- åŠ è½½ä¸­ --</option>';

        fetch('/geneface/models')
            .then(r => r.json())
            .then(models => {
                genefaceModels = {}; // é‡ç½®
                videoSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©è§’è‰² --</option>';

                if (Array.isArray(models)) {
                    models.forEach(m => {
                        genefaceModels[m.video_id] = m;
                        const opt = document.createElement('option');
                        opt.value = m.video_id;
                        opt.textContent = m.video_id;
                        videoSelect.appendChild(opt);
                    });
                }
            })
            .catch(e => {
                videoSelect.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
            });
    }

    function onVideoIdSelected() {
        const videoId = document.getElementById('gf_video_id_select').value;
        const headSelect = document.getElementById('gf_head_ckpt_select');
        const torsoSelect = document.getElementById('gf_torso_ckpt_select');

        headSelect.innerHTML = '';
        torsoSelect.innerHTML = '';

        if (videoId && genefaceModels[videoId]) {
            const data = genefaceModels[videoId];

            // å¡«å……å¤´éƒ¨æ¨¡å‹
            if (data.head_checkpoints && data.head_checkpoints.length > 0) {
                data.head_checkpoints.forEach(path => {
                    const opt = document.createElement('option');
                    opt.value = path;
                    opt.textContent = path.split('/').pop(); // åªæ˜¾ç¤ºæ–‡ä»¶å
                    headSelect.appendChild(opt);
                });
                // é»˜è®¤é€‰ç¬¬ä¸€ä¸ªï¼ˆæœ€æ–°çš„ï¼‰
                headSelect.selectedIndex = 0;
            } else {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "æ— å¯ç”¨å¤´éƒ¨æ¨¡å‹";
                headSelect.appendChild(opt);
            }

            // å¡«å……èº«ä½“æ¨¡å‹
            if (data.torso_checkpoints && data.torso_checkpoints.length > 0) {
                data.torso_checkpoints.forEach(path => {
                    const opt = document.createElement('option');
                    opt.value = path;
                    opt.textContent = path.split('/').pop(); // åªæ˜¾ç¤ºæ–‡ä»¶å
                    torsoSelect.appendChild(opt);
                });
                // é»˜è®¤é€‰ç¬¬ä¸€ä¸ªï¼ˆæœ€æ–°çš„ï¼‰
                torsoSelect.selectedIndex = 0;
            } else {
                const opt = document.createElement('option');
                opt.value = "";
                opt.textContent = "æ— å¯ç”¨èº«ä½“æ¨¡å‹";
                torsoSelect.appendChild(opt);
            }

        } else {
            headSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option>';
            torsoSelect.innerHTML = '<option value="">-- å…ˆé€‰æ‹©è§’è‰² --</option>';
        }
    }

    function refreshAudios() {
        const select = document.getElementById('gf_audio_select');
        select.innerHTML = '<option value="">-- åŠ è½½ä¸­ --</option>';

        fetch('/geneface/audios')
            .then(r => r.json())
            .then(audios => {
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
                if (Array.isArray(audios)) {
                    audios.forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = a.path;
                        opt.textContent = `${a.name} (${a.duration || '?'}s)`;
                        select.appendChild(opt);
                    });
                }
            })
            .catch(e => {
                select.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
            });
    }

    function toggleAudioSource() {
        const source = document.getElementById('audio_source').value;
        document.getElementById('existing_audio_group').style.display = source === 'existing' ? 'block' : 'none';
        document.getElementById('upload_audio_group').style.display = source === 'upload' ? 'block' : 'none';
    }

    function uploadAudio() {
        const fileInput = document.getElementById('audio_file');
        const audioName = document.getElementById('audio_name').value;
        const statusEl = document.getElementById('audio_upload_status');

        if (!fileInput.files[0]) {
            statusEl.textContent = 'è¯·é€‰æ‹©éŸ³é¢‘æ–‡ä»¶';
            statusEl.className = 'upload-status error';
            return;
        }

        const formData = new FormData();
        formData.append('audio', fileInput.files[0]);
        if (audioName) {
            formData.append('audio_name', audioName);
        }

        statusEl.textContent = 'ä¸Šä¼ ä¸­...';
        statusEl.className = 'upload-status';

        fetch('/geneface/upload_audio', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                statusEl.textContent = 'âœ“ ä¸Šä¼ æˆåŠŸ: ' + data.audio_name;
                statusEl.className = 'upload-status success';

                // åˆ‡æ¢åˆ°å·²æœ‰éŸ³é¢‘å¹¶åˆ·æ–°åˆ—è¡¨
                document.getElementById('audio_source').value = 'existing';
                toggleAudioSource();
                refreshAudios();

                // é€‰æ‹©åˆšä¸Šä¼ çš„éŸ³é¢‘
                setTimeout(() => {
                    document.getElementById('gf_audio_select').value = data.audio_path;
                }, 500);
            } else {
                statusEl.textContent = 'âœ— ' + data.message;
                statusEl.className = 'upload-status error';
            }
        })
        .catch(e => {
            statusEl.textContent = 'âœ— ä¸Šä¼ å¤±è´¥: ' + e.message;
            statusEl.className = 'upload-status error';
        });
    }

    // ==================== è¡¨å•æäº¤ ====================

    document.getElementById('videoForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const modelName = document.getElementById('model_name').value;
        const formData = new FormData(this);

        if (modelName === 'GeneFace++') {
            // éªŒè¯ GeneFace++ å‚æ•°
            const headCkpt = document.getElementById('gf_head_ckpt_select').value;
            const torsoCkpt = document.getElementById('gf_torso_ckpt_select').value;

            if (!headCkpt || !torsoCkpt) {
                alert('è¯·å…ˆé€‰æ‹©å®Œæ•´çš„æ¨¡å‹ï¼ˆè§’è‰² + å¤´éƒ¨ + èº«ä½“ï¼‰');
                return;
            }

            // æ‰‹åŠ¨æ·»åŠ åˆ° formData (ä»¥é˜² select name å±æ€§ä¸è¢«è‡ªåŠ¨è¯†åˆ«æˆ–ä¸ºäº†å®‰å…¨èµ·è§)
            // æ³¨æ„ï¼šå¦‚æœ HTML ä¸­ select å·²ç»æœ‰äº† name="gf_head_ckpt"ï¼Œè¿™é‡Œå…¶å®æ˜¯å¤šä½™çš„ï¼Œ
            // ä½†æ˜¯ä¸ºäº†ä¿è¯é€»è¾‘æ¸…æ™°ï¼Œä¿æŒåŸæ ·

            // è·å–éŸ³é¢‘è·¯å¾„
            let audioPath = '';
            const audioSource = document.getElementById('audio_source').value;
            if (audioSource === 'existing') {
                audioPath = document.getElementById('gf_audio_select').value;
            }

            if (!audioPath) {
                alert('è¯·é€‰æ‹©éŸ³é¢‘');
                return;
            }

            formData.set('gf_audio_path', audioPath);
        }

        // æ˜¾ç¤ºç”ŸæˆçŠ¶æ€
        document.getElementById('generatingStatus').classList.add('active');
        document.getElementById('statusText').textContent = 'æ­£åœ¨ç”Ÿæˆè§†é¢‘...';
        document.getElementById('submitBtn').disabled = true;

        fetch('/video_generation', {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            document.getElementById('generatingStatus').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;

            if (data.status === 'success' && data.video_path) {
                // æ›´æ–°è§†é¢‘æ’­æ”¾å™¨
                const videoEl = document.getElementById('previewVideo');
                const sourceEl = document.getElementById('videoSource');
                sourceEl.src = '/' + data.video_path + '?t=' + Date.now();
                videoEl.load();
                videoEl.play();
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(e => {
            document.getElementById('generatingStatus').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;
            alert('è¯·æ±‚å¤±è´¥: ' + e.message);
        });
    });
    </script>

    <script src="{{ url_for('static', filename='js/instruction.js') }}"></script>

</body>

</html>