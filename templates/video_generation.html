<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>视频生成</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/video_generation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/instruction.css') }}">
</head>

<body class="subpage-bg">

    <button onclick="window.location.href='/'" aria-label="返回首页" title="返回首页" class="back-btn">← 返回</button>
    <button class="vg-help-button" id="vg_openHelpBtn" aria-haspopup="dialog" aria-controls="vg_helpModal">参数说明</button>

    <div class="page-container">
        <h2>视频生成</h2>

        <div class="video-page-container">
            <!-- 左侧：预览/生成视频区域 -->
            <div class="video-display">
                <video id="previewVideo" controls width="420">
                    <source id="videoSource" src="{{ url_for('static', filename=default_video) }}" type="video/mp4">
                </video>
                <div id="generatingStatus" class="generating-status">
                    <span class="spinner"></span>
                    <span id="statusText">正在生成视频...</span>
                </div>
            </div>

            <!-- 右边输入表单 -->
            <div class="form-section">
                <form id="videoForm">
                    <div class="form-group">
                        <label>模型名称</label>
                        <select name="model_name" id="model_name" onchange="toggleModelOptions()">
                            <option value="SyncTalk">SyncTalk</option>
                            <option value="GeneFace++" selected>GeneFace++</option>
                        </select>
                    </div>

                    <!-- 公共音频驱动设置 (修改部分) -->
                    <div class="form-group">
                        <label>驱动方式</label>
                        <select id="drive_mode" onchange="toggleDriveMode()">
                            <option value="audio_file">使用音频文件</option>
                            <option value="text_gen">文本生成语音 (RVC)</option>
                        </select>
                    </div>

                    <!-- 方式A: 文本生成语音 (新增) -->
                    <div id="text_gen_options" class="text-gen-group" style="display: none;">
                        <div class="form-group">
                            <label>输入文本 (将克隆为语音)</label>
                            <textarea name="target_text" id="target_text" rows="3" placeholder="请输入要让数字人说的话..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>选择音色 (RVC)</label>
                            <select name="voice_clone" id="voice_clone">
                                <option value="zhb">zhb - 默认男声</option>
                                <option value="nahida">nahida - 纳西妲</option>
                                <!-- 可以根据需要添加更多 -->
                            </select>
                        </div>
                    </div>

                    <!-- 方式B: 音频文件 (原有的逻辑) -->
                    <div id="audio_file_options">
                        <!-- SyncTalk 的音频输入 -->
                        <div id="synctalk_audio_input" class="form-group" style="display: none;">
                            <label>参考音频地址</label>
                            <input type="text" name="ref_audio" placeholder="请输入音频路径">
                        </div>

                        <!-- GeneFace 的音频输入区域 -->
                        <div id="geneface_audio_input" class="geneface-options active">
                            
                            <!-- 1. 下拉选择框 -->
                            <div class="form-group">
                                <label>音频来源</label>
                                <select id="audio_source" onchange="toggleAudioSource()">
                                    <option value="existing">选择已有音频</option>
                                    <option value="upload">上传新音频</option>
                                </select>
                            </div>

                            <!-- 2. 选择已有音频区域 (ID: existing_audio_group) -->
                            <div class="form-group" id="existing_audio_group">
                                <div class="form-label-row">
                                    <label>选择音频</label>
                                    <button type="button" class="refresh-btn" onclick="refreshAudios()">
                                        <span class="icon">⟳</span> 刷新
                                    </button>
                                </div>
                                <select name="gf_audio" id="gf_audio_select">
                                    <option value="">-- 请选择 --</option>
                                </select>
                            </div>

                            <!-- 3. 上传新音频区域 (ID: upload_audio_group) -->
                            <!-- ★★★ 关键点：这个 ID 必须存在，且默认 style="display: none;" ★★★ -->
                            <div class="audio-source-group" id="upload_audio_group" style="display: none;">
                                
                                <label>上传音频文件 (WAV/MP3)</label>
                                
                                <!-- 文件选择器容器 -->
                                <div class="file-input-container">
                                    <input type="file" id="audio_file" accept=".wav,.mp3,.m4a" class="hidden-input" onchange="updateFileName(this)">
                                    <label for="audio_file" class="custom-file-btn">📂 点击选择文件</label>
                                    <span id="file_name_display" class="file-name-text">未选择文件</span>
                                </div>

                                <!-- 音频名称输入框 -->
                                <input type="text" id="audio_name" class="styled-input" placeholder="音频名称（可选）">

                                <!-- 上传按钮 -->
                                <button type="button" onclick="uploadAudio()" class="upload-action-btn">
                                    ⬆ 确认上传
                                </button>
                                
                                <!-- 上传状态提示 -->
                                <div id="audio_upload_status" class="upload-status"></div>
                            </div>

                        </div>
                    </div>

                    <!-- SyncTalk 选项 -->
                    <div id="synctalk_options" style="display: none;">
                        <div class="form-group">
                            <label>模型目录地址</label>
                            <input type="text" name="model_param" placeholder="请输入模型目录路径">
                        </div>
                    </div>

                    <!-- GeneFace++ 选项 -->
                    <div id="geneface_options" class="geneface-options active">
                        <div class="form-group">
                            <span id="gf_service_status" style="font-size: 12px;">检查服务中...</span>
                        </div>
                        <div class="form-group">
                            <!-- 头部区域：左侧文字，右侧按钮 -->
                            <div class="form-label-row">
                                <label>选择角色 (Video ID)</label>
                                <button type="button" class="refresh-btn" onclick="refreshModels()">
                                    <span class="icon">⟳</span> 刷新
                                </button>
                            </div>

                            <!-- 下拉选择框 -->
                            <select id="gf_video_id_select" onchange="onVideoIdSelected()">
                                <option value="">-- 请选择 --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>头部模型 (Head Checkpoint)</label>
                            <select name="gf_head_ckpt" id="gf_head_ckpt_select"><option value="">-- 先选择角色 --</option></select>
                        </div>
                        <div class="form-group">
                            <label>身体模型 (Torso Checkpoint)</label>
                            <select name="gf_torso_ckpt" id="gf_torso_ckpt_select"><option value="">-- 先选择角色 --</option></select>
                        </div>
                        <input type="hidden" name="gf_audio_path" id="gf_audio_path">
                    </div>

                    <div class="form-group">
                        <label>GPU选择</label>
                        <select name="gpu_choice">
                            <option value="GPU0">GPU 0</option>
                            <option value="GPU1">GPU 1</option>
                        </select>
                    </div>

                    <button type="submit" class="generate-btn" id="submitBtn">生成视频</button>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/video_generation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/instruction.js') }}"></script>
</body>
</html>