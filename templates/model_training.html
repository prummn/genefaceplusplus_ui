<!-- templates/model_training.html -->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å‹è®­ç»ƒç•Œé¢</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/elaboration.css') }}">
    <style>
        /* æ•´ä½“å¸ƒå±€ */
        .video-page-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            justify-content: center;
        }

        /* å·¦ä¾§åŒºåŸŸ */
        .video-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 450px;
            min-width: 450px;
            flex-shrink: 0;
        }

        /* å³ä¾§è¡¨å• - å‘å³ç§»åŠ¨ */
        .form-section {
            flex: 0 0 350px;
            margin-left: 20px;
        }

        /* è§†é¢‘æ’­æ”¾å™¨ */
        #trainVideo {
            width: 100%;
            max-width: 450px;
            background: #000;
            border-radius: 8px;
        }

        /* ä»»åŠ¡çŠ¶æ€ - æ·±è‰²ä¸»é¢˜ */
        .task-status {
            width: 100%;
            padding: 15px;
            background: #1a1a2e;
            border-radius: 8px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            box-sizing: border-box;
            color: #e0e0e0;
        }
        .task-status.active {
            display: block;
        }
        .task-status .status-row {
            margin: 8px 0;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .task-status .label {
            font-weight: bold;
            display: inline-block;
            width: 85px;
            color: #888;
            flex-shrink: 0;
        }
        .task-status .value {
            color: #e0e0e0;
        }
        .status-pending { color: #ffb74d !important; }
        .status-running { color: #4fc3f7 !important; }
        .status-completed { color: #81c784 !important; }
        .status-failed { color: #e57373 !important; }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            width: 100%;
            height: 24px;
            background: #2d2d44;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 12px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4fc3f7, #2196f3);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .progress-fill.error {
            background: linear-gradient(90deg, #e57373, #f44336);
        }

        /* æ—¥å¿—åŒºåŸŸ */
        .log-container {
            width: 100%;
            background: #1a1a2e;
            border-radius: 8px;
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            box-sizing: border-box;
        }
        .log-container.active {
            display: block;
        }
        .log-header {
            color: #888;
            font-size: 12px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .log-line {
            color: #d4d4d4;
            margin: 5px 0;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.5;
        }
        .log-line.info { color: #4fc3f7; }
        .log-line.success { color: #81c784; }
        .log-line.error { color: #e57373; }
        .log-line.warning { color: #ffb74d; }
        .log-line.step { color: #ce93d8; font-weight: bold; }
    </style>
</head>

<body class="subpage-bg">

    <button onclick="window.location.href='/'" class="back-btn">â† è¿”å›</button>
    <button class="vg-help-button" id="vg_openHelpBtn">å‚æ•°è¯´æ˜</button>

    <div class="page-container">
        <h2>æ¨¡å‹è®­ç»ƒç•Œé¢</h2>
        <div class="video-page-container">
            <!-- å·¦ä¾§ -->
            <div class="video-display">
                <video id="trainVideo" controls>
                    <source id="videoSource" src="" type="video/mp4">
                </video>

                <!-- ä»»åŠ¡çŠ¶æ€ - æ·±è‰²ä¸»é¢˜ -->
                <div id="taskStatus" class="task-status">
                    <div class="status-row">
                        <span class="label">ä»»åŠ¡ ID:</span>
                        <span class="value" id="taskId">-</span>
                    </div>
                    <div class="status-row">
                        <span class="label">çŠ¶æ€:</span>
                        <span class="value" id="taskState">-</span>
                    </div>
                    <div class="status-row">
                        <span class="label">å½“å‰æ­¥éª¤:</span>
                        <span class="value" id="taskStep">-</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill" style="width: 0%;">0%</div>
                    </div>
                    <div class="status-row" style="margin-top: 12px;">
                        <span class="label">æ¶ˆæ¯:</span>
                        <span class="value" id="taskMessage">-</span>
                    </div>
                </div>

                <!-- æ—¥å¿— -->
                <div id="logContainer" class="log-container">
                    <div class="log-header">ğŸ“‹ è®­ç»ƒæ—¥å¿—</div>
                    <div id="logContent"></div>
                </div>
            </div>

            <!-- å³ä¾§è¡¨å• -->
            <div class="form-section">
                <form id="trainForm">
                    <div class="form-group">
                        <label>æ¨¡å‹é€‰æ‹©</label>
                        <select name="model_choice" id="model_choice" onchange="toggleModelOptions()">
                            <option value="SyncTalk">SyncTalk</option>
                            <option value="GeneFace++">GeneFace++</option>
                        </select>
                    </div>

                    <div id="synctalk_options">
                        <div class="form-group">
                            <label>å‚è€ƒè§†é¢‘åœ°å€</label>
                            <input type="text" name="ref_video" placeholder="è¯·è¾“å…¥è§†é¢‘è·¯å¾„">
                        </div>
                        <div class="form-group">
                            <label>Epoch</label>
                            <input type="number" name="epoch" min="1" value="10">
                        </div>
                    </div>

                    <div id="geneface_options" style="display: none;">
                        <div class="form-group">
                            <label>è§†é¢‘æ¥æº</label>
                            <select id="video_source" onchange="toggleVideoSource()">
                                <option value="existing">é€‰æ‹©å·²æœ‰è§†é¢‘</option>
                                <option value="upload">ä¸Šä¼ æ–°è§†é¢‘</option>
                            </select>
                        </div>

                        <div class="form-group" id="existing_video_group">
                            <label>é€‰æ‹©è§†é¢‘</label>
                            <select name="video_id" id="video_select" onchange="onVideoSelected()">
                                <option value="">-- è¯·é€‰æ‹© --</option>
                            </select>
                            <button type="button" onclick="refreshVideoList()" style="margin-top: 5px;">åˆ·æ–°</button>
                        </div>

                        <div class="form-group" id="upload_video_group" style="display: none;">
                            <label>ä¸Šä¼ è§†é¢‘</label>
                            <input type="file" id="video_file" accept="video/mp4">
                            <input type="text" id="new_video_id" placeholder="Video ID" style="margin-top: 5px;">
                            <button type="button" onclick="uploadVideo()" style="margin-top: 5px;">ä¸Šä¼ </button>
                            <span id="upload_status"></span>
                        </div>

                        <div class="form-group">
                            <label>è®­ç»ƒé˜¶æ®µ</label>
                            <select name="train_stage" id="train_stage" onchange="onTrainStageChange()">
                                <option value="preprocess">1. æ•°æ®é¢„å¤„ç†</option>
                                <option value="head">2. å¤´éƒ¨æ¨¡å‹è®­ç»ƒ</option>
                                <option value="torso">3. èº«ä½“æ¨¡å‹è®­ç»ƒ</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>å¤´éƒ¨è®­ç»ƒæ­¥æ•°</label>
                            <input type="number" name="max_updates_head" value="40000" min="1000" step="1000">
                        </div>

                        <div class="form-group">
                            <label>èº«ä½“è®­ç»ƒæ­¥æ•°</label>
                            <input type="number" name="max_updates_torso" value="40000" min="1000" step="1000">
                        </div>

                        <div class="form-group" id="head_ckpt_group" style="display: none;">
                            <label>Head Checkpoint</label>
                            <input type="text" name="head_ckpt" id="head_ckpt" placeholder="è‡ªåŠ¨å¡«å……">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>GPUé€‰æ‹©</label>
                        <select name="gpu_choice">
                            <option value="GPU0">GPU 0</option>
                            <option value="GPU1">GPU 1</option>
                        </select>
                    </div>

                    <button type="submit" class="generate-btn" id="submitBtn">å¼€å§‹è®­ç»ƒ</button>
                </form>

                <div id="geneface_status" style="margin-top: 10px; display: none;">
                    <span id="service_status"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
    let pollInterval = null;
    let lastStep = '';

    function onVideoSelected() {
        const videoId = document.getElementById('video_select').value;
        const videoEl = document.getElementById('trainVideo');
        const sourceEl = document.getElementById('videoSource');
        if (videoId) {
            sourceEl.src = `/geneface/video/${videoId}`;
            videoEl.load();
            addLog(`å·²é€‰æ‹©è§†é¢‘: ${videoId}`, 'info');
        }
    }

    function toggleModelOptions() {
        const choice = document.getElementById('model_choice').value;
        document.getElementById('synctalk_options').style.display = choice === 'GeneFace++' ? 'none' : 'block';
        document.getElementById('geneface_options').style.display = choice === 'GeneFace++' ? 'block' : 'none';
        document.getElementById('geneface_status').style.display = choice === 'GeneFace++' ? 'block' : 'none';
        if (choice === 'GeneFace++') {
            checkGenefaceHealth();
            refreshVideoList();
        }
    }

    function toggleVideoSource() {
        const source = document.getElementById('video_source').value;
        document.getElementById('existing_video_group').style.display = source === 'existing' ? 'block' : 'none';
        document.getElementById('upload_video_group').style.display = source === 'upload' ? 'block' : 'none';
    }

    function onTrainStageChange() {
        document.getElementById('head_ckpt_group').style.display =
            document.getElementById('train_stage').value === 'torso' ? 'block' : 'none';
    }

    function addLog(msg, type = 'info') {
        const container = document.getElementById('logContainer');
        const content = document.getElementById('logContent');
        container.classList.add('active');

        const line = document.createElement('div');
        line.className = `log-line ${type}`;
        line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        content.appendChild(line);
        container.scrollTop = container.scrollHeight;

        while (content.children.length > 200) content.removeChild(content.firstChild);
    }

    function clearLogs() {
        document.getElementById('logContent').innerHTML = '';
    }

    function checkGenefaceHealth() {
        fetch('/geneface/health').then(r => r.json()).then(data => {
            const el = document.getElementById('service_status');
            el.innerHTML = data.status === 'ok' ? 'âœ“ GeneFace++ æœåŠ¡æ­£å¸¸' : 'âœ— ' + data.message;
            el.style.color = data.status === 'ok' ? '#81c784' : '#e57373';
        }).catch(() => {
            document.getElementById('service_status').innerHTML = 'âœ— æ— æ³•è¿æ¥';
            document.getElementById('service_status').style.color = '#e57373';
        });
    }

    function refreshVideoList() {
        const select = document.getElementById('video_select');
        select.innerHTML = '<option value="">-- åŠ è½½ä¸­ --</option>';
        fetch('/geneface/videos').then(r => r.json()).then(videos => {
            select.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>';
            if (Array.isArray(videos)) {
                videos.forEach(v => {
                    const opt = document.createElement('option');
                    opt.value = v.video_id;
                    opt.textContent = `${v.video_id} (${v.size_mb} MB)`;
                    select.appendChild(opt);
                });
                if (videos.length > 0) addLog(`å·²åŠ è½½ ${videos.length} ä¸ªè§†é¢‘`, 'info');
            }
        });
    }

    function uploadVideo() {
        const file = document.getElementById('video_file').files[0];
        const videoId = document.getElementById('new_video_id').value;
        const status = document.getElementById('upload_status');
        if (!file) { status.textContent = 'è¯·é€‰æ‹©æ–‡ä»¶'; return; }

        const formData = new FormData();
        formData.append('video', file);
        if (videoId) formData.append('video_id', videoId);
        status.textContent = 'ä¸Šä¼ ä¸­...';

        fetch('/geneface/upload', { method: 'POST', body: formData })
            .then(r => r.json()).then(data => {
                if (data.status === 'success') {
                    status.textContent = 'âœ“ æˆåŠŸ';
                    status.style.color = '#81c784';
                    document.getElementById('video_source').value = 'existing';
                    toggleVideoSource();
                    refreshVideoList();
                    setTimeout(() => {
                        document.getElementById('video_select').value = data.video_id;
                        onVideoSelected();
                    }, 500);
                } else {
                    status.textContent = 'âœ— ' + data.message;
                    status.style.color = '#e57373';
                }
            });
    }

    function updateTaskStatus(data) {
        document.getElementById('taskStatus').classList.add('active');
        document.getElementById('taskId').textContent = data.task_id || '-';

        const stateEl = document.getElementById('taskState');
        const text = {pending:'ç­‰å¾…ä¸­', running:'è¿è¡Œä¸­', completed:'å·²å®Œæˆ', failed:'å¤±è´¥'};
        stateEl.textContent = text[data.status] || data.status;
        stateEl.className = 'value status-' + data.status;

        document.getElementById('taskStep').textContent = data.current_step || '-';
        document.getElementById('taskMessage').textContent = data.message || data.error || '-';

        const fill = document.getElementById('progressFill');
        let pct = 0;
        if (data.status === 'completed') pct = 100;
        else if (data.status === 'failed') { fill.classList.add('error'); }
        else if (data.current_step) {
            const m = data.current_step.match(/(\d+)\/(\d+)/);
            if (m) pct = Math.round(parseInt(m[1]) / parseInt(m[2]) * 100);
        }
        fill.style.width = pct + '%';
        fill.textContent = pct + '%';

        if (data.head_ckpt) document.getElementById('head_ckpt').value = data.head_ckpt;
    }

    function pollTaskStatus(taskId) {
        if (pollInterval) clearInterval(pollInterval);
        lastStep = '';

        const poll = () => {
            fetch(`/geneface/task/${taskId}`).then(r => r.json()).then(data => {
                updateTaskStatus(data);
                if (data.current_step && data.current_step !== lastStep) {
                    addLog(data.current_step, 'step');
                    lastStep = data.current_step;
                }
                if (data.status === 'completed' || data.status === 'failed') {
                    addLog(data.status === 'completed' ? 'âœ“ å®Œæˆï¼' : 'âœ— å¤±è´¥: ' + (data.error || ''),
                           data.status === 'completed' ? 'success' : 'error');
                    clearInterval(pollInterval);
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'å¼€å§‹è®­ç»ƒ';
                }
            });
        };
        poll();
        pollInterval = setInterval(poll, 3000);
    }

    document.getElementById('trainForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        if (formData.get('model_choice') === 'GeneFace++') {
            const videoId = document.getElementById('video_select').value;
            if (!videoId) { alert('è¯·é€‰æ‹©è§†é¢‘'); return; }
            formData.set('video_id', videoId);
        }

        clearLogs();
        addLog('æäº¤ä»»åŠ¡...', 'info');
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').textContent = 'å¤„ç†ä¸­...';
        document.getElementById('progressFill').classList.remove('error');

        fetch('/model_training', { method: 'POST', body: formData })
            .then(r => {
                if (!r.headers.get('content-type')?.includes('application/json')) {
                    throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
                }
                return r.json();
            })
            .then(data => {
                if (data.task_id) {
                    addLog(`ä»»åŠ¡åˆ›å»º: ${data.task_id}`, 'success');
                    pollTaskStatus(data.task_id);
                } else if (data.status === 'error') {
                    addLog('é”™è¯¯: ' + data.message, 'error');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'å¼€å§‹è®­ç»ƒ';
                } else {
                    addLog('å®Œæˆ', 'success');
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'å¼€å§‹è®­ç»ƒ';
                }
            })
            .catch(e => {
                addLog('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = 'å¼€å§‹è®­ç»ƒ';
            });
    });

    document.getElementById('logContainer').classList.add('active');
    addLog('é¡µé¢å°±ç»ª', 'info');
    </script>

{#    <script src="{{ url_for('static', filename='js/model_training.js') }}"></script>#}
    <script src="{{ url_for('static', filename='js/elaboration.js') }}"></script>
</body>
</html>